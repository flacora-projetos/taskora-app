<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîß Restaurar Schema Taskora v5.5</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            background: #f1f5f9;
        }
        .container {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        h1 {
            color: #0f172a;
            margin-bottom: 30px;
            text-align: center;
        }
        .alert {
            background: #fee2e2;
            border: 2px solid #ef4444;
            color: #991b1b;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            font-weight: bold;
        }
        .warning {
            background: #fef3c7;
            border: 2px solid #f59e0b;
            color: #92400e;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            font-weight: bold;
        }
        .section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
        }
        .section h3 {
            color: #475569;
            margin-top: 0;
        }
        button {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            margin: 5px;
        }
        button:hover {
            background: #2563eb;
        }
        button:disabled {
            background: #94a3b8;
            cursor: not-allowed;
        }
        .btn-danger {
            background: #ef4444;
        }
        .btn-danger:hover {
            background: #dc2626;
        }
        .btn-success {
            background: #10b981;
        }
        .btn-success:hover {
            background: #059669;
        }
        .success {
            background: #dcfce7;
            color: #166534;
            padding: 12px;
            border-radius: 6px;
            margin: 10px 0;
        }
        .error {
            background: #fee2e2;
            color: #dc2626;
            padding: 12px;
            border-radius: 6px;
            margin: 10px 0;
        }
        .info {
            background: #dbeafe;
            color: #1e40af;
            padding: 12px;
            border-radius: 6px;
            margin: 10px 0;
        }
        .progress {
            background: #e2e8f0;
            border-radius: 8px;
            height: 20px;
            margin: 20px 0;
            overflow: hidden;
        }
        .progress-bar {
            background: #3b82f6;
            height: 100%;
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 12px;
            font-weight: bold;
        }
        .log {
            background: #1e293b;
            color: #e2e8f0;
            padding: 20px;
            border-radius: 8px;
            height: 400px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }
        .schema-preview {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            max-height: 300px;
            overflow-y: auto;
        }
        .collection-info {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            padding: 12px;
            margin: 10px 0;
        }
        .field-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 8px;
            margin: 10px 0;
        }
        .field-item {
            background: #f1f5f9;
            padding: 6px 10px;
            border-radius: 4px;
            font-size: 0.9em;
            border-left: 3px solid #3b82f6;
        }
        .required-field {
            border-left-color: #ef4444;
            background: #fef2f2;
        }
        .step {
            display: flex;
            align-items: center;
            padding: 15px;
            margin: 10px 0;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            background: #f8fafc;
        }
        .step-number {
            background: #3b82f6;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 15px;
        }
        .step-completed {
            background: #10b981;
        }
        .step-content {
            flex: 1;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß Restaurar Schema Taskora v5.5</h1>
        
        <div class="alert">
            ‚ö†Ô∏è ATEN√á√ÉO: Esta ferramenta vai RESTAURAR o schema original do Taskora v5.5 e LIMPAR dados corrompidos!
            <br><br>
            <strong>BACKUP AUTOM√ÅTICO:</strong> Todos os dados atuais ser√£o salvos antes da restaura√ß√£o.
        </div>

        <!-- Firebase Config -->
        <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
        <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

        <!-- Progresso -->
        <div class="progress">
            <div class="progress-bar" id="progressBar" style="width: 0%">0%</div>
        </div>

        <!-- Etapas do Processo -->
        <div class="section">
            <h3>Etapas da Restaura√ß√£o</h3>
            <div class="step" id="step1">
                <div class="step-number">1</div>
                <div class="step-content">
                    <strong>Conectar Firebase</strong><br>
                    <small>Estabelecer conex√£o com o Firebase Taskora</small>
                </div>
            </div>
            <div class="step" id="step2">
                <div class="step-number">2</div>
                <div class="step-content">
                    <strong>Carregar Schema Original</strong><br>
                    <small>Carregar backup do schema taskora-schema-antigo-2025-09-03.json</small>
                </div>
            </div>
            <div class="step" id="step3">
                <div class="step-number">3</div>
                <div class="step-content">
                    <strong>Backup dos Dados Atuais</strong><br>
                    <small>Salvar dados atuais antes da restaura√ß√£o</small>
                </div>
            </div>
            <div class="step" id="step4">
                <div class="step-number">4</div>
                <div class="step-content">
                    <strong>Limpar Cole√ß√µes Corrompidas</strong><br>
                    <small>Remover dados inconsistentes e campos extras</small>
                </div>
            </div>
            <div class="step" id="step5">
                <div class="step-number">5</div>
                <div class="step-content">
                    <strong>Restaurar Schema Correto</strong><br>
                    <small>Aplicar estrutura original do Taskora v5.5</small>
                </div>
            </div>
        </div>

        <!-- Controles -->
        <div class="section">
            <h3>Controles de Restaura√ß√£o</h3>
            <button onclick="iniciarRestauracao()" class="btn-success">üîß Iniciar Restaura√ß√£o Completa</button>
            <button onclick="conectarFirebase()">üîó Conectar Firebase</button>
            <button onclick="carregarSchemaOriginal()" id="btnCarregarSchema" disabled>üìñ Carregar Schema Original</button>
            <button onclick="fazerBackupAtual()" id="btnBackup" disabled>üíæ Backup Dados Atuais</button>
            <button onclick="limparColecoes()" id="btnLimpar" disabled class="btn-danger">üóëÔ∏è Limpar Cole√ß√µes</button>
            <button onclick="restaurarSchema()" id="btnRestaurar" disabled class="btn-success">‚úÖ Restaurar Schema</button>
        </div>

        <!-- Preview do Schema -->
        <div class="section">
            <h3>Preview do Schema Original</h3>
            <div id="schemaPreview" class="schema-preview">
                <p>Carregue o schema original para visualizar...</p>
            </div>
        </div>

        <!-- Status da Restaura√ß√£o -->
        <div class="section">
            <h3>Status da Restaura√ß√£o</h3>
            <div id="statusRestauracao"></div>
        </div>

        <!-- Log -->
        <div class="section">
            <h3>Log de Restaura√ß√£o</h3>
            <div class="log" id="logContainer"></div>
        </div>
    </div>

    <script>
        // Firebase Config - Taskora
        const firebaseConfig = {
            apiKey: "AIzaSyBEZokJOUgNJvjKvN8kNqQzI8Ej7cGxKzE",
            authDomain: "taskora-39404.firebaseapp.com",
            projectId: "taskora-39404",
            storageBucket: "taskora-39404.firebasestorage.app",
            messagingSenderId: "1097282772",
            appId: "1:1097282772:web:b8b8b8b8b8b8b8b8b8b8b8"
        };

        let app, db;
        let schemaOriginal = null;
        let backupAtual = {};
        let etapaAtual = 0;
        
        // Schema correto do Taskora v5.5
        const TASKORA_SCHEMA_V55 = {
            tasks: {
                required: ['orgId', 'title', 'status', 'owner', 'createdAt', 'updatedAt'],
                optional: ['clientRef', 'description', 'assigneeRef', 'priority', 'startAt', 'dueAt', 'reminderAt', 'hours', 'estimatedMinutes', 'spentMinutes', 'date', 'createdBy', 'deletedAt'],
                indexes: [
                    { fields: ['orgId', 'status'] },
                    { fields: ['orgId', 'owner'] },
                    { fields: ['orgId', 'createdAt'] }
                ]
            },
            clients: {
                required: ['orgId', 'displayName', 'status', 'tier', 'createdAt', 'updatedAt'],
                optional: ['email', 'phone', 'website', 'instagram', 'defaultAssigneeRef', 'entryDate', 'responsible', 'paymentMethod', 'documents', 'notes', 'budgets', 'activePlatforms', 'performance', 'balanceControl'],
                indexes: [
                    { fields: ['orgId', 'status'] },
                    { fields: ['orgId', 'tier'] },
                    { fields: ['orgId', 'displayName'] }
                ]
            },
            team: {
                required: ['name', 'status', 'createdAt', 'updatedAt'],
                optional: ['email', 'phone', 'specialty', 'level', 'notes'],
                indexes: [
                    { fields: ['status'] },
                    { fields: ['specialty'] }
                ]
            }
        };

        function log(message, type = 'info') {
            const logDiv = document.getElementById('logContainer');
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : 'info';
            logDiv.innerHTML += `<div class="${className}">[${timestamp}] ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function atualizarProgresso(porcentagem, etapa) {
            const progressBar = document.getElementById('progressBar');
            progressBar.style.width = porcentagem + '%';
            progressBar.textContent = porcentagem + '%';
            
            if (etapa) {
                const stepElement = document.getElementById(`step${etapa}`);
                const stepNumber = stepElement.querySelector('.step-number');
                stepNumber.classList.add('step-completed');
            }
        }

        // 1. Conectar Firebase
        async function conectarFirebase() {
            try {
                log('üîó Conectando ao Firebase Taskora...');
                app = firebase.initializeApp(firebaseConfig);
                db = firebase.firestore();
                
                // Testar conex√£o
                await db.collection('test').doc('restore_test').set({
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    status: 'restore_connected'
                });
                
                log('‚úÖ Conex√£o estabelecida com sucesso!', 'success');
                document.getElementById('btnCarregarSchema').disabled = false;
                atualizarProgresso(20, 1);
                etapaAtual = 1;
            } catch (error) {
                log(`‚ùå Erro ao conectar: ${error.message}`, 'error');
            }
        }

        // 2. Carregar Schema Original
        async function carregarSchemaOriginal() {
            try {
                log('üìñ Carregando schema original...');
                const response = await fetch('./taskora-schema-antigo-2025-09-03.json');
                schemaOriginal = await response.json();
                
                log('‚úÖ Schema original carregado!', 'success');
                mostrarPreviewSchema();
                document.getElementById('btnBackup').disabled = false;
                atualizarProgresso(40, 2);
                etapaAtual = 2;
            } catch (error) {
                log(`‚ùå Erro ao carregar schema: ${error.message}`, 'error');
                log('‚ÑπÔ∏è Usando schema interno v5.5', 'info');
                schemaOriginal = TASKORA_SCHEMA_V55;
                mostrarPreviewSchema();
                document.getElementById('btnBackup').disabled = false;
                atualizarProgresso(40, 2);
            }
        }

        // 3. Mostrar Preview do Schema
        function mostrarPreviewSchema() {
            const previewDiv = document.getElementById('schemaPreview');
            let html = '';

            for (const [collectionName, schemaInfo] of Object.entries(TASKORA_SCHEMA_V55)) {
                html += `
                    <div class="collection-info">
                        <h4>üìã ${collectionName}</h4>
                        <p><strong>Campos Obrigat√≥rios:</strong></p>
                        <div class="field-list">
                            ${schemaInfo.required.map(field => `<div class="field-item required-field">${field} *</div>`).join('')}
                        </div>
                        <p><strong>Campos Opcionais:</strong></p>
                        <div class="field-list">
                            ${schemaInfo.optional.map(field => `<div class="field-item">${field}</div>`).join('')}
                        </div>
                    </div>
                `;
            }

            previewDiv.innerHTML = html;
        }

        // 4. Fazer Backup dos Dados Atuais
        async function fazerBackupAtual() {
            if (!db) {
                log('‚ùå Firebase n√£o conectado!', 'error');
                return;
            }

            try {
                log('üíæ Fazendo backup dos dados atuais...');
                const collectionsToBackup = ['tasks', 'clients', 'team'];
                
                for (const collectionName of collectionsToBackup) {
                    try {
                        const snapshot = await db.collection(collectionName).get();
                        const docs = [];
                        snapshot.forEach(doc => {
                            docs.push({ id: doc.id, data: doc.data() });
                        });
                        backupAtual[collectionName] = docs;
                        log(`üì¶ Backup ${collectionName}: ${docs.length} documentos`);
                    } catch (error) {
                        log(`‚ö†Ô∏è Erro no backup de ${collectionName}: ${error.message}`, 'warning');
                    }
                }

                // Salvar backup em arquivo
                const backupData = {
                    timestamp: new Date().toISOString(),
                    version: 'pre-restore-backup',
                    data: backupAtual
                };
                
                const blob = new Blob([JSON.stringify(backupData, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `taskora-backup-pre-restore-${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                
                log('‚úÖ Backup salvo com sucesso!', 'success');
                document.getElementById('btnLimpar').disabled = false;
                atualizarProgresso(60, 3);
                etapaAtual = 3;
            } catch (error) {
                log(`‚ùå Erro no backup: ${error.message}`, 'error');
            }
        }

        // 5. Limpar Cole√ß√µes Corrompidas (preservando campos importantes)
        async function limparColecoes() {
            if (!db) {
                log('‚ùå Firebase n√£o conectado!', 'error');
                return;
            }

            try {
                log('üßπ Validando e corrigindo estrutura das cole√ß√µes...');
                const collectionsToClean = ['tasks', 'clients', 'team'];
                
                // Campos importantes que DEVEM ser preservados
                const fieldsToKeep = {
                    clients: ['realLeads', 'realBilling', 'monthlyLeads', 'currentROI', 'billingGoal', 'conversionRate', 'documentLinks', 'tags'],
                    team: ['averageRating', 'totalHours', 'totalTasks']
                };
                
                for (const collectionName of collectionsToClean) {
                    try {
                        log(`üîç Validando ${collectionName}...`);
                        const snapshot = await db.collection(collectionName).get();
                        const docs = snapshot.docs;
                        
                        if (docs.length === 0) {
                            log(`‚ÑπÔ∏è ${collectionName}: cole√ß√£o vazia`);
                            continue;
                        }
                        
                        const toKeep = fieldsToKeep[collectionName] || [];
                        let correctedCount = 0;
                        
                        for (const doc of docs) {
                            const docData = doc.data();
                            let hasChanges = false;
                            const updatedData = { ...docData };
                            
                            // Verifica se campos importantes est√£o presentes
                            toKeep.forEach(field => {
                                if (!(field in docData)) {
                                    // Adiciona campo com valor padr√£o se ausente
                                    if (field === 'realLeads' || field === 'realBilling' || field === 'monthlyLeads' || field === 'currentROI' || field === 'billingGoal' || field === 'conversionRate') {
                                        updatedData[field] = null;
                                    } else if (field === 'documentLinks') {
                                        updatedData[field] = '';
                                    } else if (field === 'tags') {
                                        updatedData[field] = [];
                                    } else if (field === 'averageRating' || field === 'totalHours' || field === 'totalTasks') {
                                        updatedData[field] = 0;
                                    }
                                    hasChanges = true;
                                    log(`Adicionado campo obrigat√≥rio '${field}' ao documento ${doc.id}`);
                                }
                            });
                            
                            // Atualiza documento se houve mudan√ßas
                            if (hasChanges) {
                                await doc.ref.update(updatedData);
                                correctedCount++;
                                log(`‚úÖ Documento ${doc.id} corrigido`);
                            }
                        }
                        
                        log(`‚úÖ ${collectionName}: ${correctedCount} documentos corrigidos`);
                    } catch (error) {
                        log(`‚ö†Ô∏è Erro ao validar ${collectionName}: ${error.message}`, 'warning');
                    }
                }
                
                log('‚úÖ Valida√ß√£o e corre√ß√£o conclu√≠da!', 'success');
                document.getElementById('btnRestaurar').disabled = false;
                atualizarProgresso(80, 4);
                etapaAtual = 4;
            } catch (error) {
                log(`‚ùå Erro na valida√ß√£o: ${error.message}`, 'error');
            }
        }

        // 6. Restaurar Schema Correto
        async function restaurarSchema() {
            if (!db) {
                log('‚ùå Firebase n√£o conectado!', 'error');
                return;
            }

            try {
                log('‚úÖ Restaurando schema correto do Taskora v5.5...');
                
                // Criar documentos de exemplo com schema correto
                for (const [collectionName, schemaInfo] of Object.entries(TASKORA_SCHEMA_V55)) {
                    try {
                        log(`üìã Criando estrutura para ${collectionName}...`);
                        
                        // Criar documento de exemplo com todos os campos obrigat√≥rios
                        const exampleDoc = {};
                        
                        // Campos obrigat√≥rios
                        schemaInfo.required.forEach(field => {
                            switch (field) {
                                case 'orgId':
                                    exampleDoc[field] = 'default-org';
                                    break;
                                case 'title':
                                case 'displayName':
                                case 'name':
                                    exampleDoc[field] = `Exemplo ${collectionName}`;
                                    break;
                                case 'status':
                                    exampleDoc[field] = 'active';
                                    break;
                                case 'owner':
                                    exampleDoc[field] = 'system';
                                    break;
                                case 'tier':
                                    exampleDoc[field] = 'standard';
                                    break;
                                case 'createdAt':
                                case 'updatedAt':
                                    exampleDoc[field] = firebase.firestore.FieldValue.serverTimestamp();
                                    break;
                                default:
                                    exampleDoc[field] = null;
                            }
                        });
                        
                        // Adicionar documento de exemplo
                        await db.collection(collectionName).doc('_schema_example').set(exampleDoc);
                        log(`‚úÖ ${collectionName}: estrutura criada`);
                    } catch (error) {
                        log(`‚ö†Ô∏è Erro ao criar ${collectionName}: ${error.message}`, 'warning');
                    }
                }
                
                log('üéâ Schema restaurado com sucesso!', 'success');
                atualizarProgresso(100, 5);
                etapaAtual = 5;
                
                // Mostrar status final
                document.getElementById('statusRestauracao').innerHTML = `
                    <div class="success">
                        <h4>‚úÖ Restaura√ß√£o Conclu√≠da!</h4>
                        <p>O schema original do Taskora v5.5 foi restaurado com sucesso.</p>
                        <p><strong>Pr√≥ximos passos:</strong></p>
                        <ul>
                            <li>Usar a ferramenta de migra√ß√£o de dados brutos</li>
                            <li>Validar a integridade dos dados migrados</li>
                            <li>Testar todas as funcionalidades</li>
                        </ul>
                    </div>
                `;
            } catch (error) {
                log(`‚ùå Erro na restaura√ß√£o: ${error.message}`, 'error');
            }
        }

        // 7. Processo Completo
        async function iniciarRestauracao() {
            log('üöÄ Iniciando processo completo de restaura√ß√£o...');
            
            try {
                await conectarFirebase();
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                await carregarSchemaOriginal();
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                await fazerBackupAtual();
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                await limparColecoes();
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                await restaurarSchema();
                
                log('üéâ Restaura√ß√£o completa finalizada!', 'success');
            } catch (error) {
                log(`‚ùå Erro no processo: ${error.message}`, 'error');
            }
        }
    </script>
</body>
</html>