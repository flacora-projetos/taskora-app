<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug - Dados Brutos do Firestore</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .section { margin: 20px 0; padding: 15px; border: 1px solid #ccc; }
        .data { background: #f5f5f5; padding: 10px; margin: 10px 0; }
        pre { white-space: pre-wrap; }
        .highlight { background: yellow; }
    </style>
</head>
<body>
    <h1>Debug - Dados Brutos do Firestore</h1>
    
    <div class="section">
        <h2>Dados Brutos (sem mapDbToUi)</h2>
        <div id="raw-data" class="data">Carregando...</div>
    </div>
    
    <div class="section">
        <h2>Dados Processados (com mapDbToUi)</h2>
        <div id="processed-data" class="data">Carregando...</div>
    </div>
    
    <div class="section">
        <h2>Análise de Campos Hours</h2>
        <div id="hours-analysis" class="data">Aguardando dados...</div>
    </div>

    <script src="assets/js/config/firebase-config.js" type="module"></script>
    <script type="module">
        // Aguarda a configuração do Firebase ser carregada
        function waitForFirebaseConfig() {
            return new Promise((resolve) => {
                const checkConfig = () => {
                    if (window.firebaseConfig && window.firebaseConfig.apiKey) {
                        resolve(window.firebaseConfig);
                    } else {
                        setTimeout(checkConfig, 100);
                    }
                };
                checkConfig();
            });
        }

        import { mapDbToUi } from './assets/js/data/tasksRepo.js';

        async function getDb() {
            if (window.db) return window.db;
            const config = await waitForFirebaseConfig();
            console.log('Firebase config carregado:', config);
            const appMod = await import('https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js');
            const fsMod = await import('https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js');
            const { initializeApp } = appMod;
            const { getFirestore } = fsMod;
            const app = initializeApp(config);
            window.db = getFirestore(app);
            return window.db;
        }

        async function analyzeData() {
            try {
                console.log('Analisando dados brutos do Firestore...');
                
                const db = await getDb();
                const fs = await import('https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js');
                const { collection, getDocs, limit, query } = fs;
                
                // Buscar dados brutos
                const q = query(collection(db, "tasks"), limit(10));
                const snap = await getDocs(q);
                
                const rawData = [];
                const processedData = [];
                
                for (const doc of snap.docs) {
                    const raw = doc.data();
                    const processed = await mapDbToUi(doc);
                    
                    rawData.push({ id: doc.id, ...raw });
                    processedData.push(processed);
                }
                
                console.log('Dados brutos:', rawData);
                console.log('Dados processados:', processedData);
                
                // Exibir dados brutos
                document.getElementById('raw-data').innerHTML = `
                    <strong>Total:</strong> ${rawData.length} tarefas<br><br>
                    ${rawData.map((item, index) => `
                        <div style="border: 1px solid #ddd; margin: 10px 0; padding: 10px;">
                            <strong>Tarefa ${index + 1} (ID: ${item.id}):</strong><br>
                            <span class="highlight">hours:</span> ${item.hours || 'undefined'}<br>
                            <span class="highlight">estimatedMinutes:</span> ${item.estimatedMinutes || 'undefined'}<br>
                            <strong>Todos os campos:</strong><br>
                            <pre style="font-size: 12px;">${JSON.stringify(item, null, 2)}</pre>
                        </div>
                    `).join('')}
                `;
                
                // Exibir dados processados
                document.getElementById('processed-data').innerHTML = `
                    <strong>Total:</strong> ${processedData.length} tarefas<br><br>
                    ${processedData.map((item, index) => `
                        <div style="border: 1px solid #ddd; margin: 10px 0; padding: 10px;">
                            <strong>Tarefa ${index + 1} (ID: ${item.id}):</strong><br>
                            <span class="highlight">hours:</span> ${item.hours}<br>
                            <span class="highlight">hoursHHMM:</span> ${item.hoursHHMM}<br>
                            <strong>Título:</strong> ${item.title}<br>
                        </div>
                    `).join('')}
                `;
                
                // Análise de horas
                let analysis = '<strong>Análise Detalhada:</strong><br><br>';
                let totalHours = 0;
                let tasksWithHours = 0;
                
                for (let i = 0; i < rawData.length; i++) {
                    const raw = rawData[i];
                    const processed = processedData[i];
                    
                    analysis += `<strong>Tarefa ${raw.id}:</strong><br>`;
                    analysis += `- Raw hours: ${raw.hours || 'undefined'}<br>`;
                    analysis += `- Raw estimatedMinutes: ${raw.estimatedMinutes || 'undefined'}<br>`;
                    analysis += `- Processed hours: ${processed.hours}<br>`;
                    analysis += `- Cálculo: ${raw.hours || 0} || (${raw.estimatedMinutes || 0} / 60) = ${processed.hours}<br><br>`;
                    
                    if (processed.hours > 0) {
                        totalHours += processed.hours;
                        tasksWithHours++;
                    }
                }
                
                analysis += `<div style="background: #e6f3ff; padding: 10px; margin: 10px 0;">`;
                analysis += `<strong>RESUMO:</strong><br>`;
                analysis += `- Total de tarefas: ${rawData.length}<br>`;
                analysis += `- Tarefas com horas > 0: ${tasksWithHours}<br>`;
                analysis += `- Total de horas: ${totalHours}<br>`;
                analysis += `- Horas formatadas: ${totalHours > 0 ? formatHours(totalHours) : '00:00'}<br>`;
                analysis += `</div>`;
                
                document.getElementById('hours-analysis').innerHTML = analysis;
                
            } catch (error) {
                console.error('Erro na análise:', error);
                document.getElementById('raw-data').innerHTML = 'Erro: ' + error.message;
                document.getElementById('processed-data').innerHTML = 'Erro: ' + error.message;
                document.getElementById('hours-analysis').innerHTML = 'Erro: ' + error.message;
            }
        }
        
        function formatHours(v) {
            const n = typeof v === "number" ? v : 0;
            if (n === 0) return "00:00";
            const hours = Math.floor(n);
            const minutes = Math.round((n - hours) * 60);
            return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}`;
        }

        // Executar análise quando a página carregar
        analyzeData();
    </script>
</body>
</html>