<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Migra√ß√£o D√°cora ‚Üí Taskora v5.5</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f8fafc;
        }
        .container {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        h1 {
            color: #1e293b;
            margin-bottom: 30px;
            text-align: center;
        }
        .section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
        }
        .section h3 {
            color: #475569;
            margin-top: 0;
        }
        button {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            margin: 5px;
        }
        button:hover {
            background: #2563eb;
        }
        button:disabled {
            background: #94a3b8;
            cursor: not-allowed;
        }
        .success {
            background: #dcfce7;
            color: #166534;
            padding: 12px;
            border-radius: 6px;
            margin: 10px 0;
        }
        .error {
            background: #fee2e2;
            color: #dc2626;
            padding: 12px;
            border-radius: 6px;
            margin: 10px 0;
        }
        .info {
            background: #dbeafe;
            color: #1e40af;
            padding: 12px;
            border-radius: 6px;
            margin: 10px 0;
        }
        .progress {
            background: #f1f5f9;
            border-radius: 6px;
            padding: 20px;
            margin: 20px 0;
        }
        .progress-bar {
            background: #e2e8f0;
            height: 8px;
            border-radius: 4px;
            overflow: hidden;
        }
        .progress-fill {
            background: #3b82f6;
            height: 100%;
            transition: width 0.3s ease;
        }
        pre {
            background: #f8fafc;
            padding: 15px;
            border-radius: 6px;
            overflow-x: auto;
            font-size: 12px;
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .stat-card {
            background: #f8fafc;
            padding: 15px;
            border-radius: 6px;
            text-align: center;
        }
        .stat-number {
            font-size: 24px;
            font-weight: bold;
            color: #3b82f6;
        }
        .stat-label {
            color: #64748b;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üöÄ Migra√ß√£o D√°cora ‚Üí Taskora v5.5</h1>
        
        <div class="section">
            <h3>üìã Status da Migra√ß√£o</h3>
            <div id="status">Aguardando in√≠cio...</div>
            <div class="progress" id="progressContainer" style="display: none;">
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill" style="width: 0%"></div>
                </div>
                <div id="progressText">0%</div>
            </div>
        </div>

        <div class="section">
            <h3>üîß Controles</h3>
            <button onclick="carregarBackup()">1. Carregar Backup D√°cora</button>
            <button onclick="analisarDados()" id="btnAnalisar" disabled>2. Analisar Dados</button>
            <button onclick="conectarFirebase()" id="btnConectar" disabled>3. Conectar Firebase</button>
            <button onclick="executarMigracao()" id="btnMigrar" disabled>4. Executar Migra√ß√£o</button>
            <button onclick="validarMigracao()" id="btnValidar" disabled>5. Validar Migra√ß√£o</button>
        </div>

        <div class="section">
            <h3>üìä Estat√≠sticas</h3>
            <div class="stats" id="stats">
                <div class="stat-card">
                    <div class="stat-number" id="totalTasks">-</div>
                    <div class="stat-label">Tasks</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="totalClients">-</div>
                    <div class="stat-label">Clientes</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="totalOwners">-</div>
                    <div class="stat-label">Owners</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="migrationProgress">0%</div>
                    <div class="stat-label">Progresso</div>
                </div>
            </div>
        </div>

        <div class="section">
            <h3>üìù Log de Atividades</h3>
            <div id="log" style="max-height: 400px; overflow-y: auto;"></div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <script>
        // Configura√ß√£o Firebase Taskora
        const firebaseConfig = {
            apiKey: "AIzaSyBQt2qBnUR4P3Wd3CPl3c6W9xMCz2yf6-4",
            authDomain: "taskora-39404.firebaseapp.com",
            projectId: "taskora-39404",
            storageBucket: "taskora-39404.firebasestorage.app",
            messagingSenderId: "650011927392",
            appId: "1:650011927392:web:26d75b732ecbb21dacf405"
        };

        let app, db;
        let dacoraData = null;
        let migrationStats = {
            tasks: { total: 0, migrated: 0 },
            clients: { total: 0, migrated: 0 },
            team: { total: 0, migrated: 0 }
        };

        // Fun√ß√µes de Log
        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : 'info';
            logDiv.innerHTML += `<div class="${className}">[${timestamp}] ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function updateProgress(percentage, text) {
            const progressContainer = document.getElementById('progressContainer');
            const progressFill = document.getElementById('progressFill');
            const progressText = document.getElementById('progressText');
            const migrationProgressStat = document.getElementById('migrationProgress');
            
            progressContainer.style.display = 'block';
            progressFill.style.width = percentage + '%';
            progressText.textContent = text || `${percentage}%`;
            migrationProgressStat.textContent = `${percentage}%`;
        }

        // 1. Carregar Backup D√°cora
        async function carregarBackup() {
            try {
                log('Carregando backup da D√°cora...');
                const response = await fetch('./dacora-export-2025-09-02.json');
                dacoraData = await response.json();
                
                // Atualizar estat√≠sticas
                const tasks = dacoraData.collections.tasks || [];
                const clients = dacoraData.collections.clients?.[0]?.data?.clients || [];
                const owners = dacoraData.collections.owners?.[0]?.data?.names || [];
                
                document.getElementById('totalTasks').textContent = tasks.length;
                document.getElementById('totalClients').textContent = clients.length;
                document.getElementById('totalOwners').textContent = owners.length;
                
                migrationStats.tasks.total = tasks.length;
                migrationStats.clients.total = clients.length;
                migrationStats.team.total = owners.length;
                
                log(`Backup carregado: ${tasks.length} tasks, ${clients.length} clientes, ${owners.length} owners`, 'success');
                document.getElementById('btnAnalisar').disabled = false;
            } catch (error) {
                log(`Erro ao carregar backup: ${error.message}`, 'error');
            }
        }

        // 2. Analisar Dados
        function analisarDados() {
            if (!dacoraData) {
                log('Backup n√£o carregado!', 'error');
                return;
            }

            log('Analisando estrutura dos dados...');
            
            // Analisar Tasks
            const tasks = dacoraData.collections.tasks || [];
            const taskSample = tasks.slice(0, 3);
            log(`Amostra de Tasks (${taskSample.length}/${tasks.length}):`);
            taskSample.forEach((task, i) => {
                log(`Task ${i+1}: ${JSON.stringify(task.data, null, 2)}`);
            });

            // Analisar Clientes
            const clients = dacoraData.collections.clients?.[0]?.data?.clients || [];
            const clientSample = clients.slice(0, 3);
            log(`Amostra de Clientes (${clientSample.length}/${clients.length}):`);
            clientSample.forEach((client, i) => {
                log(`Cliente ${i+1}: ${JSON.stringify(client, null, 2)}`);
            });

            // Analisar Owners
            const owners = dacoraData.collections.owners?.[0]?.data?.names || [];
            log(`Owners encontrados: ${owners.join(', ')}`);

            log('An√°lise conclu√≠da!', 'success');
            document.getElementById('btnConectar').disabled = false;
        }

        // 3. Conectar Firebase
        async function conectarFirebase() {
            try {
                log('Conectando ao Firebase Taskora...');
                app = firebase.initializeApp(firebaseConfig);
                db = firebase.firestore();
                
                // Testar conex√£o
                await db.collection('test').doc('connection').set({
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    status: 'connected'
                });
                
                log('Conex√£o com Firebase estabelecida!', 'success');
                document.getElementById('btnMigrar').disabled = false;
            } catch (error) {
                log(`Erro ao conectar Firebase: ${error.message}`, 'error');
            }
        }

        // 4. Executar Migra√ß√£o
        async function executarMigracao() {
            if (!dacoraData || !db) {
                log('Dados ou conex√£o n√£o dispon√≠veis!', 'error');
                return;
            }

            log('Iniciando migra√ß√£o...');
            updateProgress(0, 'Iniciando...');

            try {
                // Migrar Team (Owners)
                await migrarTeam();
                updateProgress(33, 'Team migrado');

                // Migrar Clients
                await migrarClients();
                updateProgress(66, 'Clientes migrados');

                // Migrar Tasks
                await migrarTasks();
                updateProgress(100, 'Migra√ß√£o conclu√≠da!');

                log('Migra√ß√£o conclu√≠da com sucesso!', 'success');
                document.getElementById('btnValidar').disabled = false;
            } catch (error) {
                log(`Erro na migra√ß√£o: ${error.message}`, 'error');
            }
        }

        // Migrar Team
        async function migrarTeam() {
            log('Migrando Team...');
            const owners = dacoraData.collections.owners?.[0]?.data?.names || [];
            const batch = db.batch();

            for (const ownerName of owners) {
                const teamDoc = db.collection('team').doc();
                const teamData = {
                    name: ownerName,
                    email: `${ownerName.toLowerCase().replace(/\s+/g, '.')}@taskora.com`,
                    phone: '',
                    specialty: ['Gest√£o de Projetos'],
                    level: 'S√™nior',
                    status: 'Ativo',
                    notes: `Migrado da D√°cora em ${new Date().toISOString()}`,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                batch.set(teamDoc, teamData);
                migrationStats.team.migrated++;
            }

            await batch.commit();
            log(`${owners.length} membros do team migrados`);
        }

        // Migrar Clients
        async function migrarClients() {
            log('Migrando Clients...');
            const clients = dacoraData.collections.clients?.[0]?.data?.clients || [];
            const batch = db.batch();

            for (const client of clients) {
                const clientDoc = db.collection('clients').doc();
                const clientData = {
                    orgId: 'dacora-migration',
                    displayName: client.name,
                    email: '',
                    phone: '',
                    website: '',
                    instagram: '',
                    status: 'Ativo',
                    tier: mapTier(client.tier),
                    defaultAssigneeRef: null,
                    entryDate: new Date().toISOString().split('T')[0],
                    responsible: client.owner || '',
                    paymentMethod: 'PIX',
                    documents: [],
                    notes: `Migrado da D√°cora. Tier original: ${client.tier}`,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    budgets: {
                        meta: { daily: 0, monthly: 0 },
                        google: { daily: 0, monthly: 0 },
                        pinterest: { daily: 0, monthly: 0 }
                    },
                    activePlatforms: {
                        meta: false,
                        google: false,
                        pinterest: false
                    },
                    performance: {
                        realBilling: 0,
                        realLeads: 0,
                        billingGoal: 0,
                        leadsGoal: 0,
                        roi: 0
                    },
                    balanceControl: {
                        meta: { lastDeposit: 0, estimatedBalance: 0 },
                        google: { lastDeposit: 0, estimatedBalance: 0 },
                        pinterest: { lastDeposit: 0, estimatedBalance: 0 }
                    }
                };
                batch.set(clientDoc, clientData);
                migrationStats.clients.migrated++;
            }

            await batch.commit();
            log(`${clients.length} clientes migrados`);
        }

        // Migrar Tasks
        async function migrarTasks() {
            log('Migrando Tasks...');
            const tasks = dacoraData.collections.tasks || [];
            const batchSize = 500;
            
            for (let i = 0; i < tasks.length; i += batchSize) {
                const batch = db.batch();
                const batchTasks = tasks.slice(i, i + batchSize);
                
                for (const task of batchTasks) {
                    const taskDoc = db.collection('tasks').doc();
                    const taskData = {
                        orgId: 'dacora-migration',
                        clientRef: null, // Ser√° preenchido ap√≥s migra√ß√£o dos clientes
                        title: task.data.description?.substring(0, 100) || 'Tarefa migrada',
                        description: task.data.description || '',
                        status: mapStatus(task.data.status),
                        assigneeRef: null,
                        owner: task.data.owner || '',
                        priority: 'M√©dia',
                        startAt: task.data.date || new Date().toISOString().split('T')[0],
                        dueAt: task.data.dueDate || task.data.date || new Date().toISOString().split('T')[0],
                        reminderAt: null,
                        hours: task.data.hours ? `${Math.floor(task.data.hours)}:${Math.round((task.data.hours % 1) * 60).toString().padStart(2, '0')}` : '0:00',
                        estimatedMinutes: task.data.hours ? Math.round(task.data.hours * 60) : 0,
                        spentMinutes: task.data.hours ? Math.round(task.data.hours * 60) : 0,
                        date: task.data.date || new Date().toISOString().split('T')[0],
                        createdBy: task.data.owner || 'Sistema',
                        createdAt: task.data.createdAt ? new Date(task.data.createdAt.seconds * 1000) : firebase.firestore.FieldValue.serverTimestamp(),
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                        deletedAt: null
                    };
                    batch.set(taskDoc, taskData);
                    migrationStats.tasks.migrated++;
                }
                
                await batch.commit();
                log(`Migradas ${Math.min(i + batchSize, tasks.length)}/${tasks.length} tasks`);
            }
            
            log(`${tasks.length} tasks migradas`);
        }

        // Fun√ß√µes de mapeamento
        function mapTier(dacoraeTier) {
            const tierMap = {
                'Key Account': 'KEY_ACCOUNT',
                'Mid Tier Account': 'MID_TIER',
                'Low Tier Account': 'LOW_TIER'
            };
            return tierMap[dacoraeTier] || 'MID_TIER';
        }

        function mapStatus(dacoraStatus) {
            const statusMap = {
                'Conclu√≠da': 'conclu√≠da',
                'Em Progresso': 'em progresso',
                'Iniciada': 'iniciada',
                'N√£o Realizada': 'n√£o realizada'
            };
            return statusMap[dacoraStatus] || 'n√£o realizada';
        }

        // 5. Validar Migra√ß√£o
        async function validarMigracao() {
            if (!db) {
                log('Conex√£o com Firebase n√£o dispon√≠vel!', 'error');
                return;
            }

            log('Validando migra√ß√£o...');

            try {
                // Contar documentos migrados
                const tasksSnapshot = await db.collection('tasks').get();
                const clientsSnapshot = await db.collection('clients').get();
                const teamSnapshot = await db.collection('team').get();

                const migratedCounts = {
                    tasks: tasksSnapshot.size,
                    clients: clientsSnapshot.size,
                    team: teamSnapshot.size
                };

                log(`Valida√ß√£o conclu√≠da:`);
                log(`- Tasks: ${migratedCounts.tasks}/${migrationStats.tasks.total}`);
                log(`- Clientes: ${migratedCounts.clients}/${migrationStats.clients.total}`);
                log(`- Team: ${migratedCounts.team}/${migrationStats.team.total}`);

                if (migratedCounts.tasks === migrationStats.tasks.total &&
                    migratedCounts.clients === migrationStats.clients.total &&
                    migratedCounts.team === migrationStats.team.total) {
                    log('‚úÖ Migra√ß√£o validada com sucesso!', 'success');
                } else {
                    log('‚ö†Ô∏è Discrep√¢ncias encontradas na migra√ß√£o', 'error');
                }
            } catch (error) {
                log(`Erro na valida√ß√£o: ${error.message}`, 'error');
            }
        }

        // Inicializa√ß√£o
        document.addEventListener('DOMContentLoaded', function() {
            log('Ferramenta de migra√ß√£o D√°cora ‚Üí Taskora v5.5 carregada');
            log('Siga os passos numerados para executar a migra√ß√£o');
        });
    </script>
</body>
</html>