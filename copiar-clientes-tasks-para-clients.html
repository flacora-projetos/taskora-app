<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîÑ Copiar Clientes: Tasks ‚Üí Clients</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f1f5f9;
        }
        .container {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        h1 {
            color: #0f172a;
            margin-bottom: 30px;
            text-align: center;
        }
        .alert {
            background: #fef3c7;
            border: 2px solid #f59e0b;
            color: #92400e;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            font-weight: bold;
        }
        .section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
        }
        button {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            margin: 5px;
        }
        button:hover {
            background: #2563eb;
        }
        button:disabled {
            background: #94a3b8;
            cursor: not-allowed;
        }
        .success {
            background: #dcfce7;
            color: #166534;
            padding: 12px;
            border-radius: 6px;
            margin: 10px 0;
        }
        .error {
            background: #fee2e2;
            color: #dc2626;
            padding: 12px;
            border-radius: 6px;
            margin: 10px 0;
        }
        .warning {
            background: #fef3c7;
            color: #92400e;
            padding: 12px;
            border-radius: 6px;
            margin: 10px 0;
        }
        .info {
            background: #dbeafe;
            color: #1e40af;
            padding: 12px;
            border-radius: 6px;
            margin: 10px 0;
        }
        .log {
            background: #1e293b;
            color: #e2e8f0;
            padding: 20px;
            border-radius: 8px;
            height: 400px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        .stat-card {
            background: #f8fafc;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            border: 1px solid #e2e8f0;
        }
        .stat-number {
            font-size: 2em;
            font-weight: bold;
            color: #3b82f6;
        }
        .stat-label {
            color: #64748b;
            font-size: 0.9em;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîÑ Copiar Clientes: Tasks ‚Üí Clients</h1>
        
        <div class="alert">
            üö® ATEN√á√ÉO: Esta ferramenta vai copiar os dados de clientes da cole√ß√£o 'tasks' para a cole√ß√£o 'clients', mantendo-os em ambos os lugares.
        </div>

        <!-- Firebase Config -->
        <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
        <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

        <!-- Estat√≠sticas -->
        <div class="stats">
            <div class="stat-card">
                <div class="stat-number" id="clientesEncontrados">0</div>
                <div class="stat-label">Clientes Encontrados em Tasks</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="clientesCriados">0</div>
                <div class="stat-label">Clientes Criados em Clients</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="clientesExistentes">0</div>
                <div class="stat-label">Clientes J√° Existentes</div>
            </div>
        </div>

        <!-- Controles -->
        <div class="section">
            <h3>üîß Controles</h3>
            <button onclick="conectarFirebase()">1. Conectar Firebase</button>
            <button id="btnAnalisar" onclick="analisarClientes()" disabled>2. Analisar Clientes</button>
            <button id="btnCopiar" onclick="copiarClientes()" disabled>3. Copiar para Clients</button>
            <button id="btnValidar" onclick="validarResultado()" disabled>4. Validar Resultado</button>
        </div>

        <!-- Log -->
        <div class="section">
            <h3>üìã Log de Opera√ß√µes</h3>
            <div id="logContainer" class="log"></div>
        </div>
    </div>

    <script>
        // Configura√ß√£o Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyBEZtyJKWH-mVbEPmhWVJOOaYVXxNJBg-8",
            authDomain: "taskora-39404.firebaseapp.com",
            projectId: "taskora-39404",
            storageBucket: "taskora-39404.firebasestorage.app",
            messagingSenderId: "185135646770",
            appId: "1:185135646770:web:b3b3b3b3b3b3b3b3b3b3b3"
        };

        let app, db;
        let clientesEncontrados = [];
        let clientesCriados = 0;
        let clientesExistentes = 0;

        function log(message, type = 'info') {
            const logDiv = document.getElementById('logContainer');
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : type === 'warning' ? 'warning' : 'info';
            logDiv.innerHTML += `<div class="${className}">[${timestamp}] ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        // 1. Conectar Firebase
        async function conectarFirebase() {
            try {
                log('üîó Conectando ao Firebase Taskora...');
                app = firebase.initializeApp(firebaseConfig);
                db = firebase.firestore();
                
                // Testar conex√£o
                await db.collection('test').doc('copy-clients').set({
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    status: 'copy_clients_connected'
                });
                
                log('‚úÖ Conex√£o estabelecida com sucesso!', 'success');
                document.getElementById('btnAnalisar').disabled = false;
            } catch (error) {
                log(`‚ùå Erro ao conectar: ${error.message}`, 'error');
            }
        }

        // 2. Analisar Clientes na Cole√ß√£o Tasks
        async function analisarClientes() {
            if (!db) {
                log('‚ùå Firebase n√£o conectado!', 'error');
                return;
            }

            log('üîç Analisando clientes na cole√ß√£o tasks...');
            clientesEncontrados = [];
            
            try {
                const tasksSnapshot = await db.collection('tasks').get();
                const clientesUnicos = new Map();
                
                tasksSnapshot.forEach(doc => {
                    const data = doc.data();
                    
                    // Verificar se √© um cliente (tem displayName e n√£o tem title)
                    if (data.displayName && !data.title) {
                        const clienteId = data.displayName.toLowerCase().replace(/\s+/g, '-');
                        
                        if (!clientesUnicos.has(clienteId)) {
                            clientesUnicos.set(clienteId, {
                                id: clienteId,
                                originalId: doc.id,
                                displayName: data.displayName,
                                orgId: data.orgId || 'default-org',
                                status: data.status || 'active',
                                tier: data.tier || 'standard',
                                createdAt: data.createdAt || firebase.firestore.FieldValue.serverTimestamp(),
                                updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                                // Campos opcionais
                                email: data.email,
                                phone: data.phone,
                                website: data.website,
                                instagram: data.instagram,
                                responsible: data.responsible,
                                paymentMethod: data.paymentMethod,
                                notes: data.notes,
                                realLeads: data.realLeads,
                                realBilling: data.realBilling,
                                monthlyLeads: data.monthlyLeads,
                                currentROI: data.currentROI,
                                billingGoal: data.billingGoal,
                                conversionRate: data.conversionRate
                            });
                        }
                    }
                });
                
                clientesEncontrados = Array.from(clientesUnicos.values());
                
                document.getElementById('clientesEncontrados').textContent = clientesEncontrados.length;
                
                log(`‚úÖ Encontrados ${clientesEncontrados.length} clientes √∫nicos na cole√ß√£o tasks`, 'success');
                
                if (clientesEncontrados.length > 0) {
                    log('üìã Clientes encontrados:');
                    clientesEncontrados.forEach(cliente => {
                        log(`   - ${cliente.displayName} (${cliente.tier})`);
                    });
                    
                    document.getElementById('btnCopiar').disabled = false;
                } else {
                    log('‚ö†Ô∏è Nenhum cliente encontrado na cole√ß√£o tasks', 'warning');
                }
                
            } catch (error) {
                log(`‚ùå Erro na an√°lise: ${error.message}`, 'error');
            }
        }

        // 3. Copiar Clientes para Cole√ß√£o Clients
        async function copiarClientes() {
            if (!db || clientesEncontrados.length === 0) {
                log('‚ùå Nenhum cliente para copiar!', 'error');
                return;
            }

            log('üîÑ Iniciando c√≥pia de clientes para a cole√ß√£o clients...');
            clientesCriados = 0;
            clientesExistentes = 0;
            
            try {
                for (const cliente of clientesEncontrados) {
                    try {
                        // Verificar se j√° existe
                        const existingDoc = await db.collection('clients').doc(cliente.id).get();
                        
                        if (existingDoc.exists) {
                            log(`‚ö†Ô∏è Cliente ${cliente.displayName} j√° existe, pulando...`, 'warning');
                            clientesExistentes++;
                        } else {
                            // Criar novo cliente
                            await db.collection('clients').doc(cliente.id).set(cliente);
                            log(`‚úÖ Cliente ${cliente.displayName} criado com sucesso`);
                            clientesCriados++;
                        }
                        
                        // Atualizar estat√≠sticas
                        document.getElementById('clientesCriados').textContent = clientesCriados;
                        document.getElementById('clientesExistentes').textContent = clientesExistentes;
                        
                    } catch (error) {
                        log(`‚ùå Erro ao copiar ${cliente.displayName}: ${error.message}`, 'error');
                    }
                }
                
                log(`‚úÖ C√≥pia conclu√≠da! ${clientesCriados} criados, ${clientesExistentes} j√° existiam`, 'success');
                document.getElementById('btnValidar').disabled = false;
                
            } catch (error) {
                log(`‚ùå Erro na c√≥pia: ${error.message}`, 'error');
            }
        }

        // 4. Validar Resultado
        async function validarResultado() {
            if (!db) {
                log('‚ùå Firebase n√£o conectado!', 'error');
                return;
            }

            log('üîç Validando resultado da c√≥pia...');
            
            try {
                const clientsSnapshot = await db.collection('clients').get();
                const totalClients = clientsSnapshot.size;
                
                log(`üìä Total de clientes na cole√ß√£o clients: ${totalClients}`);
                
                if (totalClients > 0) {
                    log('üìã Clientes na cole√ß√£o clients:');
                    clientsSnapshot.forEach(doc => {
                        const data = doc.data();
                        log(`   - ${data.displayName} (${data.tier || 'N/A'})`);
                    });
                    
                    log('‚úÖ Valida√ß√£o conclu√≠da! Os clientes agora aparecem em ambas as cole√ß√µes:', 'success');
                    log('   üìã Na cole√ß√£o TASKS (como dados de cliente)');
                    log('   üë• Na cole√ß√£o CLIENTS (como registros de cliente)');
                } else {
                    log('‚ö†Ô∏è Nenhum cliente encontrado na cole√ß√£o clients', 'warning');
                }
                
            } catch (error) {
                log(`‚ùå Erro na valida√ß√£o: ${error.message}`, 'error');
            }
        }
    </script>
</body>
</html>