<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🔄 Copiar Clientes: Tasks → Clients</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f1f5f9;
        }
        .container {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        h1 {
            color: #0f172a;
            margin-bottom: 30px;
            text-align: center;
        }
        .alert {
            background: #fef3c7;
            border: 2px solid #f59e0b;
            color: #92400e;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            font-weight: bold;
        }
        .section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
        }
        button {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            margin: 5px;
        }
        button:hover {
            background: #2563eb;
        }
        button:disabled {
            background: #94a3b8;
            cursor: not-allowed;
        }
        .success {
            background: #dcfce7;
            color: #166534;
            padding: 12px;
            border-radius: 6px;
            margin: 10px 0;
        }
        .error {
            background: #fee2e2;
            color: #dc2626;
            padding: 12px;
            border-radius: 6px;
            margin: 10px 0;
        }
        .warning {
            background: #fef3c7;
            color: #92400e;
            padding: 12px;
            border-radius: 6px;
            margin: 10px 0;
        }
        .info {
            background: #dbeafe;
            color: #1e40af;
            padding: 12px;
            border-radius: 6px;
            margin: 10px 0;
        }
        .log {
            background: #1e293b;
            color: #e2e8f0;
            padding: 20px;
            border-radius: 8px;
            height: 400px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        .stat-card {
            background: #f8fafc;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            border: 1px solid #e2e8f0;
        }
        .stat-number {
            font-size: 2em;
            font-weight: bold;
            color: #3b82f6;
        }
        .stat-label {
            color: #64748b;
            font-size: 0.9em;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🔄 Copiar Clientes: Tasks → Clients</h1>
        
        <div class="alert">
            🚨 ATENÇÃO: Esta ferramenta vai copiar os dados de clientes da coleção 'tasks' para a coleção 'clients', mantendo-os em ambos os lugares.
        </div>

        <!-- Firebase Config -->
        <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
        <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

        <!-- Estatísticas -->
        <div class="stats">
            <div class="stat-card">
                <div class="stat-number" id="clientesEncontrados">0</div>
                <div class="stat-label">Clientes Encontrados em Tasks</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="clientesCriados">0</div>
                <div class="stat-label">Clientes Criados em Clients</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="clientesExistentes">0</div>
                <div class="stat-label">Clientes Já Existentes</div>
            </div>
        </div>

        <!-- Controles -->
        <div class="section">
            <h3>🔧 Controles</h3>
            <button onclick="conectarFirebase()">1. Conectar Firebase</button>
            <button id="btnAnalisar" onclick="analisarClientes()" disabled>2. Analisar Clientes</button>
            <button id="btnCopiar" onclick="copiarClientes()" disabled>3. Copiar para Clients</button>
            <button id="btnValidar" onclick="validarResultado()" disabled>4. Validar Resultado</button>
        </div>

        <!-- Log -->
        <div class="section">
            <h3>📋 Log de Operações</h3>
            <div id="logContainer" class="log"></div>
        </div>
    </div>

    <script>
        // Configuração Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyBEZtyJKWH-mVbEPmhWVJOOaYVXxNJBg-8",
            authDomain: "taskora-39404.firebaseapp.com",
            projectId: "taskora-39404",
            storageBucket: "taskora-39404.firebasestorage.app",
            messagingSenderId: "185135646770",
            appId: "1:185135646770:web:b3b3b3b3b3b3b3b3b3b3b3"
        };

        let app, db;
        let clientesEncontrados = [];
        let clientesCriados = 0;
        let clientesExistentes = 0;

        function log(message, type = 'info') {
            const logDiv = document.getElementById('logContainer');
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : type === 'warning' ? 'warning' : 'info';
            logDiv.innerHTML += `<div class="${className}">[${timestamp}] ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        // 1. Conectar Firebase
        async function conectarFirebase() {
            try {
                log('🔗 Conectando ao Firebase Taskora...');
                app = firebase.initializeApp(firebaseConfig);
                db = firebase.firestore();
                
                // Testar conexão
                await db.collection('test').doc('copy-clients').set({
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    status: 'copy_clients_connected'
                });
                
                log('✅ Conexão estabelecida com sucesso!', 'success');
                document.getElementById('btnAnalisar').disabled = false;
            } catch (error) {
                log(`❌ Erro ao conectar: ${error.message}`, 'error');
            }
        }

        // 2. Analisar Clientes na Coleção Tasks
        async function analisarClientes() {
            if (!db) {
                log('❌ Firebase não conectado!', 'error');
                return;
            }

            log('🔍 Analisando clientes na coleção tasks...');
            clientesEncontrados = [];
            
            try {
                const tasksSnapshot = await db.collection('tasks').get();
                const clientesUnicos = new Map();
                
                tasksSnapshot.forEach(doc => {
                    const data = doc.data();
                    
                    // Verificar se é um cliente (tem displayName e não tem title)
                    if (data.displayName && !data.title) {
                        const clienteId = data.displayName.toLowerCase().replace(/\s+/g, '-');
                        
                        if (!clientesUnicos.has(clienteId)) {
                            clientesUnicos.set(clienteId, {
                                id: clienteId,
                                originalId: doc.id,
                                displayName: data.displayName,
                                orgId: data.orgId || 'default-org',
                                status: data.status || 'active',
                                tier: data.tier || 'standard',
                                createdAt: data.createdAt || firebase.firestore.FieldValue.serverTimestamp(),
                                updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                                // Campos opcionais
                                email: data.email,
                                phone: data.phone,
                                website: data.website,
                                instagram: data.instagram,
                                responsible: data.responsible,
                                paymentMethod: data.paymentMethod,
                                notes: data.notes,
                                realLeads: data.realLeads,
                                realBilling: data.realBilling,
                                monthlyLeads: data.monthlyLeads,
                                currentROI: data.currentROI,
                                billingGoal: data.billingGoal,
                                conversionRate: data.conversionRate
                            });
                        }
                    }
                });
                
                clientesEncontrados = Array.from(clientesUnicos.values());
                
                document.getElementById('clientesEncontrados').textContent = clientesEncontrados.length;
                
                log(`✅ Encontrados ${clientesEncontrados.length} clientes únicos na coleção tasks`, 'success');
                
                if (clientesEncontrados.length > 0) {
                    log('📋 Clientes encontrados:');
                    clientesEncontrados.forEach(cliente => {
                        log(`   - ${cliente.displayName} (${cliente.tier})`);
                    });
                    
                    document.getElementById('btnCopiar').disabled = false;
                } else {
                    log('⚠️ Nenhum cliente encontrado na coleção tasks', 'warning');
                }
                
            } catch (error) {
                log(`❌ Erro na análise: ${error.message}`, 'error');
            }
        }

        // 3. Copiar Clientes para Coleção Clients
        async function copiarClientes() {
            if (!db || clientesEncontrados.length === 0) {
                log('❌ Nenhum cliente para copiar!', 'error');
                return;
            }

            log('🔄 Iniciando cópia de clientes para a coleção clients...');
            clientesCriados = 0;
            clientesExistentes = 0;
            
            try {
                for (const cliente of clientesEncontrados) {
                    try {
                        // Verificar se já existe
                        const existingDoc = await db.collection('clients').doc(cliente.id).get();
                        
                        if (existingDoc.exists) {
                            log(`⚠️ Cliente ${cliente.displayName} já existe, pulando...`, 'warning');
                            clientesExistentes++;
                        } else {
                            // Criar novo cliente
                            await db.collection('clients').doc(cliente.id).set(cliente);
                            log(`✅ Cliente ${cliente.displayName} criado com sucesso`);
                            clientesCriados++;
                        }
                        
                        // Atualizar estatísticas
                        document.getElementById('clientesCriados').textContent = clientesCriados;
                        document.getElementById('clientesExistentes').textContent = clientesExistentes;
                        
                    } catch (error) {
                        log(`❌ Erro ao copiar ${cliente.displayName}: ${error.message}`, 'error');
                    }
                }
                
                log(`✅ Cópia concluída! ${clientesCriados} criados, ${clientesExistentes} já existiam`, 'success');
                document.getElementById('btnValidar').disabled = false;
                
            } catch (error) {
                log(`❌ Erro na cópia: ${error.message}`, 'error');
            }
        }

        // 4. Validar Resultado
        async function validarResultado() {
            if (!db) {
                log('❌ Firebase não conectado!', 'error');
                return;
            }

            log('🔍 Validando resultado da cópia...');
            
            try {
                const clientsSnapshot = await db.collection('clients').get();
                const totalClients = clientsSnapshot.size;
                
                log(`📊 Total de clientes na coleção clients: ${totalClients}`);
                
                if (totalClients > 0) {
                    log('📋 Clientes na coleção clients:');
                    clientsSnapshot.forEach(doc => {
                        const data = doc.data();
                        log(`   - ${data.displayName} (${data.tier || 'N/A'})`);
                    });
                    
                    log('✅ Validação concluída! Os clientes agora aparecem em ambas as coleções:', 'success');
                    log('   📋 Na coleção TASKS (como dados de cliente)');
                    log('   👥 Na coleção CLIENTS (como registros de cliente)');
                } else {
                    log('⚠️ Nenhum cliente encontrado na coleção clients', 'warning');
                }
                
            } catch (error) {
                log(`❌ Erro na validação: ${error.message}`, 'error');
            }
        }
    </script>
</body>
</html>