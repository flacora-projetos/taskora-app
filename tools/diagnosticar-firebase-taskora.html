<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîç Diagn√≥stico Firebase Taskora v5.5</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            background: #f1f5f9;
        }
        .container {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        h1 {
            color: #0f172a;
            margin-bottom: 30px;
            text-align: center;
        }
        .alert {
            background: #fef3c7;
            border: 2px solid #f59e0b;
            color: #92400e;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            font-weight: bold;
        }
        .section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
        }
        .section h3 {
            color: #475569;
            margin-top: 0;
        }
        button {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            margin: 5px;
        }
        button:hover {
            background: #2563eb;
        }
        button:disabled {
            background: #94a3b8;
            cursor: not-allowed;
        }
        .success {
            background: #dcfce7;
            color: #166534;
            padding: 12px;
            border-radius: 6px;
            margin: 10px 0;
        }
        .error {
            background: #fee2e2;
            color: #dc2626;
            padding: 12px;
            border-radius: 6px;
            margin: 10px 0;
        }
        .warning {
            background: #fef3c7;
            color: #92400e;
            padding: 12px;
            border-radius: 6px;
            margin: 10px 0;
        }
        .info {
            background: #dbeafe;
            color: #1e40af;
            padding: 12px;
            border-radius: 6px;
            margin: 10px 0;
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        .stat-card {
            background: #f8fafc;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            border: 1px solid #e2e8f0;
        }
        .stat-number {
            font-size: 2em;
            font-weight: bold;
            color: #3b82f6;
        }
        .stat-label {
            color: #64748b;
            font-size: 0.9em;
            margin-top: 5px;
        }
        .log {
            background: #1e293b;
            color: #e2e8f0;
            padding: 20px;
            border-radius: 8px;
            height: 400px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }
        .collection-analysis {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
        }
        .field-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin: 10px 0;
        }
        .field-item {
            background: white;
            padding: 8px 12px;
            border-radius: 4px;
            border: 1px solid #e2e8f0;
            font-size: 0.9em;
        }
        .field-correct {
            border-color: #10b981;
            background: #ecfdf5;
            color: #065f46;
        }
        .field-missing {
            border-color: #f59e0b;
            background: #fffbeb;
            color: #92400e;
        }
        .field-extra {
            border-color: #ef4444;
            background: #fef2f2;
            color: #991b1b;
        }
        .comparison-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }
        .comparison-table th,
        .comparison-table td {
            border: 1px solid #e2e8f0;
            padding: 12px;
            text-align: left;
        }
        .comparison-table th {
            background: #f8fafc;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Diagn√≥stico Firebase Taskora v5.5</h1>
        
        <div class="alert">
            üö® DIAGN√ìSTICO: Esta ferramenta vai analisar o estado atual do Firebase e comparar com o schema correto do Taskora v5.5
        </div>

        <!-- Firebase Config -->
        <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
        <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

        <!-- Estat√≠sticas Gerais -->
        <div class="stats">
            <div class="stat-card">
                <div class="stat-number" id="totalCollections">0</div>
                <div class="stat-label">Cole√ß√µes Encontradas</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="totalDocuments">0</div>
                <div class="stat-label">Total de Documentos</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="schemaCompliance">0%</div>
                <div class="stat-label">Conformidade Schema</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="dataIntegrity">0%</div>
                <div class="stat-label">Integridade dos Dados</div>
            </div>
        </div>

        <!-- Controles -->
        <div class="section">
            <h3>1. Conectar e Analisar Firebase</h3>
            <button onclick="conectarFirebase()">Conectar Firebase</button>
            <button onclick="analisarColecoes()" id="btnAnalisar" disabled>Analisar Cole√ß√µes</button>
            <button onclick="compararSchema()" id="btnComparar" disabled>Comparar com Schema Correto</button>
        </div>

        <div class="section">
            <h3>2. Carregar Schema de Refer√™ncia</h3>
            <button onclick="carregarSchemaCorreto()">Carregar Schema Taskora v5.5</button>
            <button onclick="carregarBackupSchema()" id="btnBackupSchema" disabled>Carregar Backup Schema</button>
        </div>

        <!-- An√°lise das Cole√ß√µes -->
        <div class="section">
            <h3>3. An√°lise Detalhada das Cole√ß√µes</h3>
            <div id="collectionAnalysis"></div>
        </div>

        <!-- Compara√ß√£o de Schema -->
        <div class="section">
            <h3>4. Compara√ß√£o de Schema</h3>
            <div id="schemaComparison"></div>
        </div>

        <!-- Recomenda√ß√µes -->
        <div class="section">
            <h3>5. Recomenda√ß√µes de Corre√ß√£o</h3>
            <div id="recommendations"></div>
        </div>

        <!-- Log -->
        <div class="section">
            <h3>Log de Diagn√≥stico</h3>
            <div class="log" id="logContainer"></div>
        </div>
    </div>

    <script>
        // Firebase Config - Taskora
        const firebaseConfig = {
            apiKey: "AIzaSyBEZokJOUgNJvjKvN8kNqQzI8Ej7cGxKzE",
            authDomain: "taskora-39404.firebaseapp.com",
            projectId: "taskora-39404",
            storageBucket: "taskora-39404.firebasestorage.app",
            messagingSenderId: "1097282772",
            appId: "1:1097282772:web:b8b8b8b8b8b8b8b8b8b8b8"
        };

        let app, db;
        let currentCollections = {};
        let correctSchema = {};
        let backupSchema = {};
        let diagnosticResults = {
            collections: {},
            compliance: 0,
            integrity: 0,
            issues: []
        };

        // Schema correto do Taskora v5.5
        const TASKORA_SCHEMA_V55 = {
            tasks: {
                required: ['orgId', 'title', 'status', 'owner', 'createdAt', 'updatedAt'],
                optional: ['clientRef', 'description', 'assigneeRef', 'priority', 'startAt', 'dueAt', 'reminderAt', 'hours', 'estimatedMinutes', 'spentMinutes', 'date', 'createdBy', 'deletedAt']
            },
            clients: {
                required: ['orgId', 'displayName', 'status', 'tier', 'createdAt', 'updatedAt'],
                optional: ['email', 'phone', 'website', 'instagram', 'defaultAssigneeRef', 'entryDate', 'responsible', 'paymentMethod', 'documents', 'notes', 'budgets', 'activePlatforms', 'performance', 'balanceControl', 'realLeads', 'realBilling', 'monthlyLeads', 'currentROI', 'billingGoal', 'conversionRate', 'documentLinks', 'tags']
            },
            team: {
                required: ['name', 'status', 'createdAt', 'updatedAt'],
                optional: ['email', 'phone', 'specialty', 'level', 'notes', 'averageRating', 'totalHours', 'totalTasks']
            }
        };

        function log(message, type = 'info') {
            const logDiv = document.getElementById('logContainer');
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : type === 'warning' ? 'warning' : 'info';
            logDiv.innerHTML += `<div class="${className}">[${timestamp}] ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        // 1. Conectar Firebase
        async function conectarFirebase() {
            try {
                log('üîó Conectando ao Firebase Taskora...');
                app = firebase.initializeApp(firebaseConfig);
                db = firebase.firestore();
                
                // Testar conex√£o
                await db.collection('test').doc('diagnostic').set({
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    status: 'diagnostic_connected'
                });
                
                log('‚úÖ Conex√£o estabelecida com sucesso!', 'success');
                document.getElementById('btnAnalisar').disabled = false;
            } catch (error) {
                log(`‚ùå Erro ao conectar: ${error.message}`, 'error');
            }
        }

        // 2. Analisar Cole√ß√µes Existentes
        async function analisarColecoes() {
            if (!db) {
                log('‚ùå Firebase n√£o conectado!', 'error');
                return;
            }

            log('üîç Analisando cole√ß√µes existentes...');
            
            try {
                // Listar todas as cole√ß√µes conhecidas
                const collectionsToCheck = ['tasks', 'clients', 'team', 'test'];
                let totalDocs = 0;
                let totalCollections = 0;

                for (const collectionName of collectionsToCheck) {
                    try {
                        const snapshot = await db.collection(collectionName).limit(1).get();
                        if (!snapshot.empty) {
                            totalCollections++;
                            const fullSnapshot = await db.collection(collectionName).get();
                            const docCount = fullSnapshot.size;
                            totalDocs += docCount;
                            
                            // Analisar estrutura dos documentos
                            const sampleDoc = fullSnapshot.docs[0];
                            const fields = Object.keys(sampleDoc.data());
                            
                            currentCollections[collectionName] = {
                                count: docCount,
                                fields: fields,
                                sampleData: sampleDoc.data()
                            };
                            
                            log(`üìã ${collectionName}: ${docCount} documentos, campos: ${fields.join(', ')}`);
                        }
                    } catch (error) {
                        log(`‚ö†Ô∏è Cole√ß√£o ${collectionName} n√£o encontrada ou inacess√≠vel`, 'warning');
                    }
                }

                document.getElementById('totalCollections').textContent = totalCollections;
                document.getElementById('totalDocuments').textContent = totalDocs;
                
                log(`‚úÖ An√°lise conclu√≠da: ${totalCollections} cole√ß√µes, ${totalDocs} documentos`, 'success');
                document.getElementById('btnComparar').disabled = false;
                
                // Mostrar an√°lise detalhada
                mostrarAnaliseDetalhada();
                
            } catch (error) {
                log(`‚ùå Erro na an√°lise: ${error.message}`, 'error');
            }
        }

        // 3. Mostrar An√°lise Detalhada
        function mostrarAnaliseDetalhada() {
            const analysisDiv = document.getElementById('collectionAnalysis');
            let html = '';

            for (const [collectionName, data] of Object.entries(currentCollections)) {
                html += `
                    <div class="collection-analysis">
                        <h4>üìã Cole√ß√£o: ${collectionName}</h4>
                        <p><strong>Documentos:</strong> ${data.count}</p>
                        <p><strong>Campos encontrados:</strong></p>
                        <div class="field-list">
                            ${data.fields.map(field => `<div class="field-item">${field}</div>`).join('')}
                        </div>
                        <details>
                            <summary>Exemplo de documento</summary>
                            <pre>${JSON.stringify(data.sampleData, null, 2)}</pre>
                        </details>
                    </div>
                `;
            }

            analysisDiv.innerHTML = html;
        }

        // 4. Schema Correto Taskora v5.5 (Incorporado)
        function carregarSchemaCorreto() {
            log('üìñ Carregando schema correto do Taskora v5.5...');
            
            // Schema j√° est√° definido na vari√°vel TASKORA_SCHEMA_V55
            log('‚úÖ Schema correto carregado!', 'success');
            document.getElementById('btnBackupSchema').disabled = false;
        }

        // 5. Backup Schema (Simulado)
        function carregarBackupSchema() {
            log('üì¶ Carregando backup do schema...');
            
            // Simular backup - na pr√°tica, seria carregado via input file
            backupSchema = {
                collections: {
                    tasks: { count: 0, fields: [] },
                    clients: { count: 0, fields: [] },
                    team: { count: 0, fields: [] }
                }
            };
            
            log('‚úÖ Backup do schema carregado!', 'success');
        }

        // 6. Comparar com Schema Correto
        function compararSchema() {
            log('üîç Comparando com schema correto...');
            
            const comparisonDiv = document.getElementById('schemaComparison');
            const recommendationsDiv = document.getElementById('recommendations');
            
            let complianceScore = 0;
            let totalChecks = 0;
            let issues = [];
            let recommendations = [];

            let html = '<table class="comparison-table">';
            html += '<tr><th>Cole√ß√£o</th><th>Status</th><th>Campos Corretos</th><th>Campos Ausentes</th><th>Campos Extras</th></tr>';

            for (const [collectionName, schemaInfo] of Object.entries(TASKORA_SCHEMA_V55)) {
                totalChecks++;
                
                if (currentCollections[collectionName]) {
                    const currentFields = currentCollections[collectionName].fields;
                    const requiredFields = schemaInfo.required;
                    const optionalFields = schemaInfo.optional || [];
                    const allValidFields = [...requiredFields, ...optionalFields];
                    
                    const missingRequired = requiredFields.filter(field => !currentFields.includes(field));
                    const extraFields = currentFields.filter(field => !allValidFields.includes(field));
                    const correctFields = currentFields.filter(field => allValidFields.includes(field));
                    
                    let status = '‚úÖ OK';
                    if (missingRequired.length > 0) {
                        status = '‚ùå CR√çTICO';
                        issues.push(`${collectionName}: Campos obrigat√≥rios ausentes: ${missingRequired.join(', ')}`);
                        recommendations.push(`Restaurar campos obrigat√≥rios em ${collectionName}: ${missingRequired.join(', ')}`);
                    } else if (extraFields.length > 0) {
                        status = '‚ö†Ô∏è ATEN√á√ÉO';
                        issues.push(`${collectionName}: Campos extras encontrados: ${extraFields.join(', ')}`);
                        recommendations.push(`Remover campos extras de ${collectionName}: ${extraFields.join(', ')}`);
                    } else {
                        complianceScore++;
                    }
                    
                    html += `<tr>`;
                    html += `<td>${collectionName}</td>`;
                    html += `<td>${status}</td>`;
                    html += `<td>${correctFields.length}</td>`;
                    html += `<td>${missingRequired.join(', ') || 'Nenhum'}</td>`;
                    html += `<td>${extraFields.join(', ') || 'Nenhum'}</td>`;
                    html += `</tr>`;
                } else {
                    html += `<tr>`;
                    html += `<td>${collectionName}</td>`;
                    html += `<td>‚ùå AUSENTE</td>`;
                    html += `<td>0</td>`;
                    html += `<td>Cole√ß√£o inteira</td>`;
                    html += `<td>N/A</td>`;
                    html += `</tr>`;
                    
                    issues.push(`Cole√ß√£o ${collectionName} n√£o encontrada`);
                    recommendations.push(`Criar cole√ß√£o ${collectionName} com schema correto`);
                }
            }
            
            html += '</table>';
            comparisonDiv.innerHTML = html;
            
            // Calcular scores
            const compliance = Math.round((complianceScore / totalChecks) * 100);
            const integrity = issues.length === 0 ? 100 : Math.max(0, 100 - (issues.length * 20));
            
            document.getElementById('schemaCompliance').textContent = compliance + '%';
            document.getElementById('dataIntegrity').textContent = integrity + '%';
            
            // Mostrar recomenda√ß√µes
            let recHtml = '';
            if (recommendations.length > 0) {
                recHtml += '<div class="error"><h4>üö® A√ß√µes Necess√°rias:</h4><ul>';
                recommendations.forEach(rec => {
                    recHtml += `<li>${rec}</li>`;
                });
                recHtml += '</ul></div>';
            } else {
                recHtml = '<div class="success">‚úÖ Schema est√° em conformidade!</div>';
            }
            
            recommendationsDiv.innerHTML = recHtml;
            
            // Log dos resultados
            log(`üìä Conformidade: ${compliance}%, Integridade: ${integrity}%`);
            if (issues.length > 0) {
                log(`‚ö†Ô∏è ${issues.length} problemas encontrados`, 'warning');
                issues.forEach(issue => log(`   - ${issue}`, 'warning'));
            } else {
                log('‚úÖ Nenhum problema cr√≠tico encontrado!', 'success');
            }
        }
    </script>
</body>
</html>