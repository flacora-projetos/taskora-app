<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Limpeza Completa Firebase - Taskora</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .container {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.5em;
        }
        .warning {
            background: #fff3cd;
            border: 2px solid #ffeaa7;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            text-align: center;
        }
        .danger {
            background: #f8d7da;
            border: 2px solid #f5c6cb;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            text-align: center;
            color: #721c24;
        }
        .success {
            background: #d4edda;
            border: 2px solid #c3e6cb;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            text-align: center;
            color: #155724;
        }
        button {
            background: linear-gradient(45deg, #ff6b6b, #ee5a24);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 18px;
            font-weight: bold;
            margin: 10px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }
        .progress {
            width: 100%;
            height: 20px;
            background: #f0f0f0;
            border-radius: 10px;
            overflow: hidden;
            margin: 20px 0;
        }
        .progress-bar {
            height: 100%;
            background: linear-gradient(45deg, #00b894, #00cec9);
            width: 0%;
            transition: width 0.3s ease;
        }
        #log {
            background: #2d3436;
            color: #00ff00;
            padding: 20px;
            border-radius: 10px;
            font-family: 'Courier New', monospace;
            max-height: 300px;
            overflow-y: auto;
            margin: 20px 0;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üßπ Limpeza Completa Firebase</h1>
        
        <div class="danger">
            <h3>‚ö†Ô∏è ATEN√á√ÉO - OPERA√á√ÉO IRREVERS√çVEL ‚ö†Ô∏è</h3>
            <p>Esta ferramenta ir√° <strong>APAGAR COMPLETAMENTE</strong> todas as cole√ß√µes e dados do Firebase:</p>
            <ul style="text-align: left; display: inline-block;">
                <li>Cole√ß√£o <strong>clients</strong></li>
                <li>Cole√ß√£o <strong>tasks</strong></li>
                <li>Cole√ß√£o <strong>team</strong></li>
                <li>Cole√ß√£o <strong>owners</strong> (se existir)</li>
                <li>Cole√ß√£o <strong>calendarEvents</strong> (se existir)</li>
                <li>Todos os documentos e subcole√ß√µes</li>
            </ul>
        </div>

        <div class="warning">
            <p><strong>Certifique-se de ter backup dos dados importantes!</strong></p>
        </div>

        <div style="text-align: center;">
            <button onclick="iniciarLimpeza()" id="btnLimpar">üóëÔ∏è LIMPAR TUDO AGORA</button>
        </div>

        <div class="progress" style="display: none;" id="progressContainer">
            <div class="progress-bar" id="progressBar"></div>
        </div>

        <div id="log" style="display: none;"></div>

        <div id="resultado" style="display: none;"></div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, collection, getDocs, deleteDoc, doc, writeBatch } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        import { getAuth, signInAnonymously } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';

        // Configura√ß√£o do Firebase da D√°cora
        const firebaseConfig = {
            apiKey: "AIzaSyD8Qv-wQBJsGrYAhY_6T1iHdWCjtjmxtEQ",
            authDomain: "dacora---tarefas.firebaseapp.com",
            projectId: "dacora---tarefas",
            storageBucket: "dacora---tarefas.firebasestorage.app",
            messagingSenderId: "406318974539",
            appId: "1:406318974539:web:d842997c1b064c0ba56fce"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        let logElement;
        let progressBar;
        let progressContainer;
        let resultado;

        function log(message) {
            console.log(message);
            if (logElement) {
                logElement.textContent += new Date().toLocaleTimeString() + ': ' + message + '\n';
                logElement.scrollTop = logElement.scrollHeight;
            }
        }

        function updateProgress(percent) {
            if (progressBar) {
                progressBar.style.width = percent + '%';
            }
        }

        async function limparColecao(nomeColecao) {
            log(`Iniciando limpeza da cole√ß√£o: ${nomeColecao}`);
            
            try {
                const colecaoRef = collection(db, nomeColecao);
                const snapshot = await getDocs(colecaoRef);
                
                if (snapshot.empty) {
                    log(`Cole√ß√£o ${nomeColecao} j√° est√° vazia`);
                    return 0;
                }

                const totalDocs = snapshot.size;
                log(`Encontrados ${totalDocs} documentos em ${nomeColecao}`);

                // Deletar em lotes para melhor performance
                const batchSize = 500;
                let deletedCount = 0;
                
                const docs = snapshot.docs;
                for (let i = 0; i < docs.length; i += batchSize) {
                    const batch = writeBatch(db);
                    const batchDocs = docs.slice(i, i + batchSize);
                    
                    batchDocs.forEach(docSnapshot => {
                        batch.delete(docSnapshot.ref);
                    });
                    
                    await batch.commit();
                    deletedCount += batchDocs.length;
                    
                    log(`Deletados ${deletedCount}/${totalDocs} documentos de ${nomeColecao}`);
                }

                log(`‚úÖ Cole√ß√£o ${nomeColecao} limpa completamente (${deletedCount} documentos removidos)`);
                return deletedCount;
                
            } catch (error) {
                log(`‚ùå Erro ao limpar ${nomeColecao}: ${error.message}`);
                throw error;
            }
        }

        window.iniciarLimpeza = async function() {
            const btnLimpar = document.getElementById('btnLimpar');
            logElement = document.getElementById('log');
            progressBar = document.getElementById('progressBar');
            progressContainer = document.getElementById('progressContainer');
            resultado = document.getElementById('resultado');

            // Confirma√ß√£o dupla
            if (!confirm('‚ö†Ô∏è ATEN√á√ÉO: Esta opera√ß√£o ir√° APAGAR TODOS OS DADOS do Firebase!\n\nTem certeza que deseja continuar?')) {
                return;
            }

            if (!confirm('üö® √öLTIMA CONFIRMA√á√ÉO: Todos os dados ser√£o PERDIDOS PERMANENTEMENTE!\n\nConfirma a limpeza completa?')) {
                return;
            }

            // Autentica√ß√£o an√¥nima primeiro
            try {
                log('üîê Fazendo autentica√ß√£o an√¥nima...');
                await signInAnonymously(auth);
                log('‚úÖ Autentica√ß√£o realizada com sucesso');
            } catch (authError) {
                log(`‚ùå Erro na autentica√ß√£o: ${authError.message}`);
                alert('Erro na autentica√ß√£o. Verifique a configura√ß√£o do Firebase.');
                return;
            }

            btnLimpar.disabled = true;
            logElement.style.display = 'block';
            progressContainer.style.display = 'block';
            logElement.textContent = '';

            log('üöÄ Iniciando limpeza completa do Firebase...');
            log('‚ö†Ô∏è  OPERA√á√ÉO IRREVERS√çVEL EM ANDAMENTO');

            const colecoes = ['clients', 'tasks', 'team', 'owners', 'calendarEvents'];
            let totalDeletados = 0;
            let coletionsLimpas = 0;

            try {
                for (let i = 0; i < colecoes.length; i++) {
                    const nomeColecao = colecoes[i];
                    updateProgress((i / colecoes.length) * 100);
                    
                    const deletados = await limparColecao(nomeColecao);
                    totalDeletados += deletados;
                    coletionsLimpas++;
                    
                    updateProgress(((i + 1) / colecoes.length) * 100);
                }

                log('\nüéâ LIMPEZA COMPLETA FINALIZADA!');
                log(`üìä Resumo:`);
                log(`   - Cole√ß√µes processadas: ${coletionsLimpas}/${colecoes.length}`);
                log(`   - Total de documentos removidos: ${totalDeletados}`);
                log(`   - Status: Firebase completamente limpo`);

                resultado.innerHTML = `
                    <div class="success">
                        <h3>‚úÖ Limpeza Completa Realizada!</h3>
                        <p><strong>${totalDeletados}</strong> documentos foram removidos</p>
                        <p><strong>${coletionsLimpas}</strong> cole√ß√µes foram processadas</p>
                        <p>O Firebase est√° agora completamente limpo e pronto para receber novos dados.</p>
                    </div>
                `;
                resultado.style.display = 'block';

            } catch (error) {
                log(`\n‚ùå ERRO DURANTE A LIMPEZA: ${error.message}`);
                resultado.innerHTML = `
                    <div class="danger">
                        <h3>‚ùå Erro na Limpeza</h3>
                        <p>Ocorreu um erro durante a limpeza: ${error.message}</p>
                        <p>Verifique o console para mais detalhes.</p>
                    </div>
                `;
                resultado.style.display = 'block';
            } finally {
                btnLimpar.disabled = false;
                btnLimpar.textContent = 'üîÑ Limpar Novamente';
            }
        };
    </script>
</body>
</html>