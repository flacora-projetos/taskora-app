<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Migra√ß√£o: CalendarEvents ‚Üí Tasks - Taskora</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 900px; margin: 50px auto; padding: 20px; }
        .container { background: #f5f5f5; padding: 20px; border-radius: 8px; }
        .warning { background: #fff3cd; border: 1px solid #ffeaa7; padding: 15px; border-radius: 4px; margin: 20px 0; }
        button { background: #014029; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; margin: 5px; }
        button:hover { background: #022d1f; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        button.danger { background: #dc3545; }
        button.danger:hover { background: #c82333; }
        .log { background: white; padding: 15px; border-radius: 4px; margin-top: 20px; max-height: 500px; overflow-y: auto; font-family: monospace; font-size: 12px; }
        .success { color: #014029; }
        .error { color: #dc3545; }
        .warning-text { color: #856404; }
        .info { color: #0c5460; }
        .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin: 20px 0; }
        .stat-card { background: white; padding: 15px; border-radius: 4px; text-align: center; }
        .stat-number { font-size: 24px; font-weight: bold; color: #014029; }
        .stat-label { font-size: 12px; color: #666; text-transform: uppercase; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîÑ Migra√ß√£o: CalendarEvents ‚Üí Tasks</h1>
        <p>Este script migra dados antigos da cole√ß√£o <code>calendarEvents</code> para a nova cole√ß√£o <code>tasks</code>.</p>
        
        <div class="warning">
            <strong>‚ö†Ô∏è ATEN√á√ÉO:</strong>
            <ul>
                <li>Esta opera√ß√£o √© <strong>irrevers√≠vel</strong></li>
                <li>Fa√ßa backup do Firebase antes de executar</li>
                <li>Execute apenas uma vez</li>
                <li>Verifique se h√° dados em ambas as cole√ß√µes</li>
            </ul>
        </div>
        
        <div class="stats" id="stats">
            <div class="stat-card">
                <div class="stat-number" id="calendarCount">-</div>
                <div class="stat-label">CalendarEvents</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="tasksCount">-</div>
                <div class="stat-label">Tasks Existentes</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="migratedCount">0</div>
                <div class="stat-label">Migrados</div>
            </div>
        </div>
        
        <button id="analyzeBtn" onclick="analyzeCollections()">üîç Analisar Cole√ß√µes</button>
        <button id="migrateBtn" onclick="migrateData()" disabled>üöÄ Migrar Dados</button>
        <button class="danger" onclick="clearTasks()" disabled id="clearBtn">üóëÔ∏è Limpar Tasks (Perigoso)</button>
        <button onclick="clearLog()">üìù Limpar Log</button>
        
        <div id="log" class="log">
            <p>Clique em "Analisar Cole√ß√µes" para come√ßar...</p>
        </div>
    </div>

    <script>
        // Configura√ß√£o do Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyBEWmvJT9PoSuC17QqOmNHZ-dqcQOmOmHZ",
            authDomain: "taskora-dacora.firebaseapp.com",
            projectId: "taskora-dacora",
            storageBucket: "taskora-dacora.firebasestorage.app",
            messagingSenderId: "798584108634",
            appId: "1:798584108634:web:f8e6c1b7c17c7b5a6e4f2d"
        };

        let firebaseApp = null;
        let db = null;
        let calendarData = [];
        let tasksData = [];

        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const className = type;
            logDiv.innerHTML += `<p class="${className}">[${timestamp}] ${message}</p>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function clearLog() {
            document.getElementById('log').innerHTML = '<p>Log limpo...</p>';
        }

        function updateStats() {
            document.getElementById('calendarCount').textContent = calendarData.length;
            document.getElementById('tasksCount').textContent = tasksData.length;
        }

        async function initFirebase() {
            if (firebaseApp && db) return { app: firebaseApp, db };
            
            try {
                log('üîß Inicializando Firebase...', 'info');
                
                const { initializeApp } = await import('https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js');
                const { getFirestore } = await import('https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js');
                
                firebaseApp = initializeApp(firebaseConfig);
                db = getFirestore(firebaseApp);
                
                log('‚úÖ Firebase inicializado com sucesso', 'success');
                return { app: firebaseApp, db };
                
            } catch (error) {
                log(`‚ùå Erro ao inicializar Firebase: ${error.message}`, 'error');
                throw error;
            }
        }

        async function analyzeCollections() {
            const btn = document.getElementById('analyzeBtn');
            btn.disabled = true;
            btn.textContent = 'Analisando...';
            
            try {
                log('üîç Iniciando an√°lise das cole√ß√µes...', 'info');
                
                const { db: database } = await initFirebase();
                const { collection, getDocs } = await import('https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js');
                
                // Analisar calendarEvents
                log('üìÖ Analisando cole√ß√£o calendarEvents...', 'info');
                const calendarSnap = await getDocs(collection(database, 'calendarEvents'));
                calendarData = [];
                calendarSnap.forEach(doc => {
                    calendarData.push({ id: doc.id, ...doc.data() });
                });
                log(`üìä Encontrados ${calendarData.length} documentos em calendarEvents`, 'info');
                
                // Analisar tasks
                log('üìã Analisando cole√ß√£o tasks...', 'info');
                const tasksSnap = await getDocs(collection(database, 'tasks'));
                tasksData = [];
                tasksSnap.forEach(doc => {
                    tasksData.push({ id: doc.id, ...doc.data() });
                });
                log(`üìä Encontrados ${tasksData.length} documentos em tasks`, 'info');
                
                updateStats();
                
                // An√°lise detalhada
                if (calendarData.length > 0) {
                    log('üîç Analisando estrutura dos calendarEvents...', 'info');
                    const sample = calendarData[0];
                    const fields = Object.keys(sample);
                    log(`üìù Campos encontrados: ${fields.join(', ')}`, 'info');
                    
                    // Verificar se s√£o realmente tarefas
                    const taskLikeFields = ['description', 'status', 'client', 'owner', 'date'];
                    const hasTaskFields = taskLikeFields.some(field => fields.includes(field));
                    
                    if (hasTaskFields) {
                        log('‚úÖ CalendarEvents cont√©m dados de tarefas - migra√ß√£o recomendada', 'success');
                        document.getElementById('migrateBtn').disabled = false;
                    } else {
                        log('‚ö†Ô∏è CalendarEvents n√£o parece conter dados de tarefas', 'warning-text');
                    }
                } else {
                    log('‚ÑπÔ∏è Nenhum dado encontrado em calendarEvents', 'info');
                }
                
                if (tasksData.length > 0) {
                    log('‚ÑπÔ∏è J√° existem dados na cole√ß√£o tasks', 'warning-text');
                    document.getElementById('clearBtn').disabled = false;
                }
                
                log('üéâ An√°lise conclu√≠da!', 'success');
                
            } catch (error) {
                log(`‚ùå Erro na an√°lise: ${error.message}`, 'error');
                console.error('Erro completo:', error);
            } finally {
                btn.disabled = false;
                btn.textContent = 'üîç Analisar Cole√ß√µes';
            }
        }

        async function migrateData() {
            if (!confirm('Tem certeza que deseja migrar os dados? Esta opera√ß√£o √© irrevers√≠vel!')) {
                return;
            }
            
            const btn = document.getElementById('migrateBtn');
            btn.disabled = true;
            btn.textContent = 'Migrando...';
            
            try {
                log('üöÄ Iniciando migra√ß√£o de dados...', 'info');
                
                const { db: database } = await initFirebase();
                const { collection, addDoc, serverTimestamp } = await import('https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js');
                
                let migratedCount = 0;
                let errorCount = 0;
                
                for (let i = 0; i < calendarData.length; i++) {
                    const item = calendarData[i];
                    
                    try {
                        log(`‚è≥ Migrando item ${i + 1}/${calendarData.length}: ${item.description || item.title || 'Sem t√≠tulo'}`, 'info');
                        
                        // Preparar dados para tasks
                        const taskData = {
                            // Campos essenciais
                            description: item.description || item.title || item.task || 'Tarefa migrada',
                            status: item.status || 'n√£o realizada',
                            
                            // Campos opcionais
                            client: item.client || item.clientName || null,
                            owner: item.owner || item.ownerName || item.responsavel || null,
                            date: item.date || item.data || null,
                            priority: item.priority || 'MEDIUM',
                            hours: item.hours || item.estimatedMinutes ? (item.estimatedMinutes / 60) : null,
                            estimatedMinutes: item.estimatedMinutes || (item.hours ? item.hours * 60 : null),
                            
                            // Timestamps
                            startAt: item.startAt || null,
                            dueAt: item.dueAt || null,
                            
                            // Metadados
                            orgId: item.orgId || 'dacora',
                            notes: item.notes || item.observacoes || null,
                            
                            // Preservar dados originais
                            migratedFrom: 'calendarEvents',
                            originalId: item.id,
                            migratedAt: serverTimestamp(),
                            createdAt: item.createdAt || serverTimestamp(),
                            updatedAt: serverTimestamp()
                        };
                        
                        // Remover campos undefined/null desnecess√°rios
                        Object.keys(taskData).forEach(key => {
                            if (taskData[key] === null || taskData[key] === undefined) {
                                delete taskData[key];
                            }
                        });
                        
                        const docRef = await addDoc(collection(database, 'tasks'), taskData);
                        log(`‚úÖ Migrado com sucesso: ${docRef.id}`, 'success');
                        migratedCount++;
                        
                        // Atualizar contador na UI
                        document.getElementById('migratedCount').textContent = migratedCount;
                        
                        // Pausa para evitar sobrecarga
                        await new Promise(resolve => setTimeout(resolve, 200));
                        
                    } catch (error) {
                        log(`‚ùå Erro ao migrar item ${i + 1}: ${error.message}`, 'error');
                        errorCount++;
                    }
                }
                
                log(`üéâ Migra√ß√£o conclu√≠da!`, 'success');
                log(`üìä Resultado: ${migratedCount} migrados, ${errorCount} erros`, 'info');
                
                if (migratedCount > 0) {
                    log('‚úÖ Dados migrados com sucesso para a cole√ß√£o tasks!', 'success');
                    log('üí° Agora voc√™ pode testar a integra√ß√£o Team ‚Üî Tasks', 'info');
                    log('üîÑ Recarregue o Taskora para ver os dados migrados', 'info');
                }
                
            } catch (error) {
                log(`‚ùå Erro geral na migra√ß√£o: ${error.message}`, 'error');
                console.error('Erro completo:', error);
            } finally {
                btn.disabled = false;
                btn.textContent = 'üöÄ Migrar Dados';
            }
        }

        async function clearTasks() {
            if (!confirm('ATEN√á√ÉO: Isso ir√° DELETAR TODOS os dados da cole√ß√£o tasks! Tem certeza?')) {
                return;
            }
            
            if (!confirm('√öLTIMA CHANCE: Esta opera√ß√£o √© IRREVERS√çVEL! Confirma a exclus√£o?')) {
                return;
            }
            
            try {
                log('üóëÔ∏è Limpando cole√ß√£o tasks...', 'warning-text');
                
                const { db: database } = await initFirebase();
                const { collection, getDocs, deleteDoc, doc } = await import('https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js');
                
                const tasksSnap = await getDocs(collection(database, 'tasks'));
                let deletedCount = 0;
                
                for (const taskDoc of tasksSnap.docs) {
                    await deleteDoc(doc(database, 'tasks', taskDoc.id));
                    deletedCount++;
                    log(`üóëÔ∏è Deletado: ${taskDoc.id}`, 'warning-text');
                }
                
                log(`‚úÖ ${deletedCount} documentos deletados da cole√ß√£o tasks`, 'success');
                tasksData = [];
                updateStats();
                
            } catch (error) {
                log(`‚ùå Erro ao limpar tasks: ${error.message}`, 'error');
            }
        }
    </script>
</body>
</html>