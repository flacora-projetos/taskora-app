<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Limpeza de Cole√ß√µes Legadas - Taskora</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 900px; margin: 50px auto; padding: 20px; }
        .container { background: #f5f5f5; padding: 20px; border-radius: 8px; }
        .danger-zone { background: #fff5f5; border: 2px solid #fed7d7; padding: 20px; border-radius: 8px; margin: 20px 0; }
        .warning { background: #fff3cd; border: 1px solid #ffeaa7; padding: 15px; border-radius: 4px; margin: 20px 0; }
        .success-zone { background: #f0fff4; border: 1px solid #9ae6b4; padding: 15px; border-radius: 4px; margin: 20px 0; }
        button { background: #014029; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; margin: 5px; }
        button:hover { background: #022d1f; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        button.danger { background: #dc3545; }
        button.danger:hover { background: #c82333; }
        button.warning { background: #ffc107; color: #212529; }
        button.warning:hover { background: #e0a800; }
        .log { background: white; padding: 15px; border-radius: 4px; margin-top: 20px; max-height: 500px; overflow-y: auto; font-family: monospace; font-size: 12px; }
        .success { color: #014029; }
        .error { color: #dc3545; }
        .warning-text { color: #856404; }
        .info { color: #0c5460; }
        .danger-text { color: #721c24; font-weight: bold; }
        .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin: 20px 0; }
        .stat-card { background: white; padding: 15px; border-radius: 4px; text-align: center; }
        .stat-number { font-size: 24px; font-weight: bold; color: #014029; }
        .stat-label { font-size: 12px; color: #666; text-transform: uppercase; }
        .checklist { background: white; padding: 15px; border-radius: 4px; margin: 15px 0; }
        .checklist h4 { margin-top: 0; color: #014029; }
        .checklist label { display: block; margin: 10px 0; cursor: pointer; }
        .checklist input[type="checkbox"] { margin-right: 10px; }
        .backup-section { background: #e8f4fd; border: 1px solid #bee5eb; padding: 15px; border-radius: 4px; margin: 15px 0; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üßπ Limpeza de Cole√ß√µes Legadas</h1>
        <p>Este script remove com seguran√ßa as cole√ß√µes <code>owners</code> e <code>calendarEvents</code> ap√≥s a migra√ß√£o.</p>
        
        <div class="danger-zone">
            <h3>‚ö†Ô∏è ZONA DE PERIGO</h3>
            <p><strong>Esta opera√ß√£o √© IRREVERS√çVEL!</strong></p>
            <ul>
                <li>S√≥ execute ap√≥s confirmar que a migra√ß√£o foi bem-sucedida</li>
                <li>Fa√ßa backup completo do Firebase antes de prosseguir</li>
                <li>Teste todas as funcionalidades do Taskora antes da limpeza</li>
                <li>Tenha certeza de que n√£o precisa mais dos dados legados</li>
            </ul>
        </div>
        
        <div class="stats" id="stats">
            <div class="stat-card">
                <div class="stat-number" id="ownersCount">-</div>
                <div class="stat-label">Owners Legados</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="calendarCount">-</div>
                <div class="stat-label">Calendar Events</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="tasksCount">-</div>
                <div class="stat-label">Tasks Atuais</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="teamCount">-</div>
                <div class="stat-label">Team Members</div>
            </div>
        </div>
        
        <button id="analyzeBtn" onclick="analyzeCollections()">üîç Analisar Estado Atual</button>
        <button onclick="clearLog()">üìù Limpar Log</button>
        
        <div class="checklist" id="checklist" style="display: none;">
            <h4>‚úÖ Checklist de Seguran√ßa</h4>
            <label><input type="checkbox" id="check1"> Fiz backup completo do Firebase</label>
            <label><input type="checkbox" id="check2"> Migra√ß√£o de calendarEvents ‚Üí tasks foi bem-sucedida</label>
            <label><input type="checkbox" id="check3"> Testei cria√ß√£o/edi√ß√£o de tarefas no Taskora</label>
            <label><input type="checkbox" id="check4"> Testei filtros de respons√°vel com membros do Team</label>
            <label><input type="checkbox" id="check5"> Confirmei que n√£o preciso mais dos dados legados</label>
            <label><input type="checkbox" id="check6"> Entendo que esta opera√ß√£o √© IRREVERS√çVEL</label>
        </div>
        
        <div class="backup-section" id="backupSection" style="display: none;">
            <h4>üíæ Backup de Seguran√ßa</h4>
            <p>Antes de limpar, voc√™ pode fazer backup dos dados legados:</p>
            <button class="warning" onclick="exportLegacyData()">üì• Exportar Dados Legados (JSON)</button>
        </div>
        
        <div id="dangerButtons" style="display: none;">
            <button class="danger" onclick="cleanupOwners()" id="cleanOwnersBtn" disabled>üóëÔ∏è Limpar Cole√ß√£o 'owners'</button>
            <button class="danger" onclick="cleanupCalendarEvents()" id="cleanCalendarBtn" disabled>üóëÔ∏è Limpar Cole√ß√£o 'calendarEvents'</button>
            <button class="danger" onclick="cleanupAll()" id="cleanAllBtn" disabled>üí• Limpar TUDO (owners + calendarEvents)</button>
        </div>
        
        <div id="log" class="log">
            <p>Clique em "Analisar Estado Atual" para come√ßar...</p>
        </div>
    </div>

    <script>
        // Configura√ß√£o do Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyBEWmvJT9PoSuC17QqOmNHZ-dqcQOmOmHZ",
            authDomain: "taskora-dacora.firebaseapp.com",
            projectId: "taskora-dacora",
            storageBucket: "taskora-dacora.firebasestorage.app",
            messagingSenderId: "798584108634",
            appId: "1:798584108634:web:f8e6c1b7c17c7b5a6e4f2d"
        };

        let firebaseApp = null;
        let db = null;
        let collectionsData = {
            owners: [],
            calendarEvents: [],
            tasks: [],
            team: []
        };

        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const className = type;
            logDiv.innerHTML += `<p class="${className}">[${timestamp}] ${message}</p>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function clearLog() {
            document.getElementById('log').innerHTML = '<p>Log limpo...</p>';
        }

        function updateStats() {
            document.getElementById('ownersCount').textContent = collectionsData.owners.length;
            document.getElementById('calendarCount').textContent = collectionsData.calendarEvents.length;
            document.getElementById('tasksCount').textContent = collectionsData.tasks.length;
            document.getElementById('teamCount').textContent = collectionsData.team.length;
        }

        function checkAllBoxes() {
            const checkboxes = document.querySelectorAll('#checklist input[type="checkbox"]');
            const allChecked = Array.from(checkboxes).every(cb => cb.checked);
            
            const buttons = ['cleanOwnersBtn', 'cleanCalendarBtn', 'cleanAllBtn'];
            buttons.forEach(btnId => {
                document.getElementById(btnId).disabled = !allChecked;
            });
            
            return allChecked;
        }

        async function initFirebase() {
            if (firebaseApp && db) return { app: firebaseApp, db };
            
            try {
                log('üîß Inicializando Firebase...', 'info');
                
                const { initializeApp } = await import('https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js');
                const { getFirestore } = await import('https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js');
                
                firebaseApp = initializeApp(firebaseConfig);
                db = getFirestore(firebaseApp);
                
                log('‚úÖ Firebase inicializado com sucesso', 'success');
                return { app: firebaseApp, db };
                
            } catch (error) {
                log(`‚ùå Erro ao inicializar Firebase: ${error.message}`, 'error');
                throw error;
            }
        }

        async function analyzeCollections() {
            const btn = document.getElementById('analyzeBtn');
            btn.disabled = true;
            btn.textContent = 'Analisando...';
            
            try {
                log('üîç Iniciando an√°lise completa das cole√ß√µes...', 'info');
                
                const { db: database } = await initFirebase();
                const { collection, getDocs } = await import('https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js');
                
                // Analisar todas as cole√ß√µes
                const collections = ['owners', 'calendarEvents', 'tasks', 'team'];
                
                for (const collectionName of collections) {
                    try {
                        log(`üìä Analisando cole√ß√£o '${collectionName}'...`, 'info');
                        const snap = await getDocs(collection(database, collectionName));
                        collectionsData[collectionName] = [];
                        
                        snap.forEach(doc => {
                            collectionsData[collectionName].push({ id: doc.id, ...doc.data() });
                        });
                        
                        log(`üìà ${collectionName}: ${collectionsData[collectionName].length} documentos`, 'info');
                    } catch (error) {
                        log(`‚ö†Ô∏è Cole√ß√£o '${collectionName}' n√£o existe ou erro: ${error.message}`, 'warning-text');
                        collectionsData[collectionName] = [];
                    }
                }
                
                updateStats();
                
                // An√°lise de seguran√ßa
                log('üîç Analisando seguran√ßa da migra√ß√£o...', 'info');
                
                const hasLegacyData = collectionsData.owners.length > 0 || collectionsData.calendarEvents.length > 0;
                const hasNewData = collectionsData.tasks.length > 0 && collectionsData.team.length > 0;
                
                if (!hasNewData) {
                    log('‚ùå PERIGO: N√£o h√° dados suficientes nas cole√ß√µes novas (tasks/team)', 'danger-text');
                    log('‚ùå N√ÉO execute a limpeza at√© migrar os dados corretamente!', 'danger-text');
                    return;
                }
                
                if (!hasLegacyData) {
                    log('‚ÑπÔ∏è N√£o h√° dados legados para limpar', 'info');
                    return;
                }
                
                log('‚úÖ An√°lise conclu√≠da - dados novos encontrados', 'success');
                log('‚ö†Ô∏è Dados legados encontrados - limpeza dispon√≠vel', 'warning-text');
                
                // Mostrar checklist e bot√µes
                document.getElementById('checklist').style.display = 'block';
                document.getElementById('backupSection').style.display = 'block';
                document.getElementById('dangerButtons').style.display = 'block';
                
                // Configurar listeners para checkboxes
                const checkboxes = document.querySelectorAll('#checklist input[type="checkbox"]');
                checkboxes.forEach(cb => {
                    cb.addEventListener('change', checkAllBoxes);
                });
                
                log('üìã Complete o checklist de seguran√ßa para habilitar a limpeza', 'info');
                
            } catch (error) {
                log(`‚ùå Erro na an√°lise: ${error.message}`, 'error');
                console.error('Erro completo:', error);
            } finally {
                btn.disabled = false;
                btn.textContent = 'üîç Analisar Estado Atual';
            }
        }

        async function exportLegacyData() {
            try {
                log('üíæ Exportando dados legados...', 'info');
                
                const backupData = {
                    timestamp: new Date().toISOString(),
                    collections: {
                        owners: collectionsData.owners,
                        calendarEvents: collectionsData.calendarEvents
                    },
                    stats: {
                        ownersCount: collectionsData.owners.length,
                        calendarEventsCount: collectionsData.calendarEvents.length
                    }
                };
                
                const blob = new Blob([JSON.stringify(backupData, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `taskora-legacy-backup-${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                log('‚úÖ Backup exportado com sucesso', 'success');
                
            } catch (error) {
                log(`‚ùå Erro ao exportar backup: ${error.message}`, 'error');
            }
        }

        async function cleanupOwners() {
            if (!checkAllBoxes()) {
                alert('Complete o checklist de seguran√ßa primeiro!');
                return;
            }
            
            if (!confirm('ATEN√á√ÉO: Isso ir√° DELETAR PERMANENTEMENTE todos os dados da cole√ß√£o \'owners\'. Confirma?')) {
                return;
            }
            
            try {
                log('üóëÔ∏è Iniciando limpeza da cole√ß√£o \'owners\'...', 'warning-text');
                
                const { db: database } = await initFirebase();
                const { collection, getDocs, deleteDoc, doc } = await import('https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js');
                
                const snap = await getDocs(collection(database, 'owners'));
                let deletedCount = 0;
                
                for (const ownerDoc of snap.docs) {
                    await deleteDoc(doc(database, 'owners', ownerDoc.id));
                    deletedCount++;
                    log(`üóëÔ∏è Deletado owner: ${ownerDoc.id}`, 'warning-text');
                    await new Promise(resolve => setTimeout(resolve, 100));
                }
                
                log(`‚úÖ Cole√ß√£o 'owners' limpa: ${deletedCount} documentos removidos`, 'success');
                collectionsData.owners = [];
                updateStats();
                
            } catch (error) {
                log(`‚ùå Erro ao limpar owners: ${error.message}`, 'error');
            }
        }

        async function cleanupCalendarEvents() {
            if (!checkAllBoxes()) {
                alert('Complete o checklist de seguran√ßa primeiro!');
                return;
            }
            
            if (!confirm('ATEN√á√ÉO: Isso ir√° DELETAR PERMANENTEMENTE todos os dados da cole√ß√£o \'calendarEvents\'. Confirma?')) {
                return;
            }
            
            try {
                log('üóëÔ∏è Iniciando limpeza da cole√ß√£o \'calendarEvents\'...', 'warning-text');
                
                const { db: database } = await initFirebase();
                const { collection, getDocs, deleteDoc, doc } = await import('https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js');
                
                const snap = await getDocs(collection(database, 'calendarEvents'));
                let deletedCount = 0;
                
                for (const eventDoc of snap.docs) {
                    await deleteDoc(doc(database, 'calendarEvents', eventDoc.id));
                    deletedCount++;
                    log(`üóëÔ∏è Deletado event: ${eventDoc.id}`, 'warning-text');
                    await new Promise(resolve => setTimeout(resolve, 100));
                }
                
                log(`‚úÖ Cole√ß√£o 'calendarEvents' limpa: ${deletedCount} documentos removidos`, 'success');
                collectionsData.calendarEvents = [];
                updateStats();
                
            } catch (error) {
                log(`‚ùå Erro ao limpar calendarEvents: ${error.message}`, 'error');
            }
        }

        async function cleanupAll() {
            if (!checkAllBoxes()) {
                alert('Complete o checklist de seguran√ßa primeiro!');
                return;
            }
            
            if (!confirm('√öLTIMA CHANCE: Isso ir√° DELETAR PERMANENTEMENTE TODAS as cole√ß√µes legadas (owners + calendarEvents). Confirma?')) {
                return;
            }
            
            if (!confirm('TEM CERTEZA ABSOLUTA? Esta opera√ß√£o √© IRREVERS√çVEL!')) {
                return;
            }
            
            try {
                log('üí• Iniciando limpeza completa das cole√ß√µes legadas...', 'danger-text');
                
                await cleanupOwners();
                await new Promise(resolve => setTimeout(resolve, 1000));
                await cleanupCalendarEvents();
                
                log('üéâ Limpeza completa finalizada!', 'success');
                log('‚úÖ Banco de dados otimizado - apenas cole√ß√µes modernas mantidas', 'success');
                log('üìä Cole√ß√µes ativas: tasks, team, clients', 'info');
                
            } catch (error) {
                log(`‚ùå Erro na limpeza completa: ${error.message}`, 'error');
            }
        }
    </script>
</body>
</html>