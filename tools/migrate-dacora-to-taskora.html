<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Migra√ß√£o D√°cora ‚Üí Taskora v5.5</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .container {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.2em;
        }
        .section {
            margin: 20px 0;
            padding: 20px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            background: #f9f9f9;
        }
        .section h3 {
            color: #555;
            margin-top: 0;
        }
        button {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
            transition: all 0.3s ease;
        }
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }
        .status {
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            font-weight: bold;
        }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        .warning { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        .log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 15px;
            max-height: 300px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            white-space: pre-wrap;
        }
        .progress {
            width: 100%;
            height: 20px;
            background: #e0e0e0;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }
        .progress-bar {
            height: 100%;
            background: linear-gradient(45deg, #667eea, #764ba2);
            width: 0%;
            transition: width 0.3s ease;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîÑ Migra√ß√£o D√°cora ‚Üí Taskora v5.5</h1>
        
        <div class="section">
            <h3>üìä Status da Migra√ß√£o</h3>
            <div id="connectionStatus" class="status info">Conectando ao Firebase...</div>
            <div class="progress">
                <div id="progressBar" class="progress-bar"></div>
            </div>
            <div id="progressText">0% - Aguardando in√≠cio</div>
        </div>

        <div class="section">
            <h3>üéØ A√ß√µes de Migra√ß√£o</h3>
            <button id="analyzeBtn" onclick="analyzeData()">1. Analisar Dados Existentes</button>
            <button id="migrateBtn" onclick="startMigration()" disabled>2. Executar Migra√ß√£o</button>
            <button id="validateBtn" onclick="validateMigration()" disabled>3. Validar Migra√ß√£o</button>
            <button id="exportBtn" onclick="exportResults()" disabled>4. Exportar Relat√≥rio</button>
        </div>

        <div class="section">
            <h3>üìã Log de Atividades</h3>
            <div id="logArea" class="log">Aguardando in√≠cio da migra√ß√£o...</div>
        </div>

        <div class="section">
            <h3>üìà Estat√≠sticas</h3>
            <div id="stats">
                <p><strong>Clientes (settings > clients):</strong> <span id="clientsCount">-</span></p>
                <p><strong>Equipe (owners):</strong> <span id="teamCount">-</span></p>
                <p><strong>Migrados com sucesso:</strong> <span id="migratedCount">-</span></p>
                <p><strong>Erros encontrados:</strong> <span id="errorsCount">-</span></p>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>

    <script>
        // Configura√ß√£o do Firebase (D√°cora) - CONFIGURA√á√ÉO CORRETA
        const firebaseConfig = {
            apiKey: "AIzaSyD8Qv-wQBJsGrYAhY_6T1iHdWCjtjmxtEQ",
            authDomain: "dacora---tarefas.firebaseapp.com",
            projectId: "dacora---tarefas",
            storageBucket: "dacora---tarefas.firebasestorage.app",
            messagingSenderId: "406318974539",
            appId: "1:406318974539:web:d842997c1b064c0ba56fce"
        };

        // Inicializar Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        let migrationData = {
            clients: [],
            team: [],
            errors: [],
            stats: { total: 0, migrated: 0, errors: 0 }
        };

        // Fun√ß√µes de utilidade
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logArea = document.getElementById('logArea');
            logArea.textContent += `[${timestamp}] ${message}\n`;
            logArea.scrollTop = logArea.scrollHeight;
            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        function updateProgress(percent, text) {
            document.getElementById('progressBar').style.width = percent + '%';
            document.getElementById('progressText').textContent = `${percent}% - ${text}`;
        }

        function updateStats() {
            document.getElementById('clientsCount').textContent = migrationData.clients.length;
            document.getElementById('teamCount').textContent = migrationData.team.length;
            document.getElementById('migratedCount').textContent = migrationData.stats.migrated;
            document.getElementById('errorsCount').textContent = migrationData.stats.errors;
        }

        function showStatus(message, type) {
            const statusDiv = document.getElementById('connectionStatus');
            statusDiv.textContent = message;
            statusDiv.className = `status ${type}`;
        }

        // Inicializa√ß√£o
        async function initializeApp() {
            try {
                // Tentar autentica√ß√£o an√¥nima
                await auth.signInAnonymously();
                showStatus('‚úÖ Conectado ao Firebase com sucesso!', 'success');
                log('Firebase inicializado com sucesso');
                document.getElementById('analyzeBtn').disabled = false;
            } catch (error) {
                console.warn('Erro na autentica√ß√£o:', error);
                showStatus('‚ö†Ô∏è Conectado sem autentica√ß√£o (modo limitado)', 'warning');
                log('Continuando sem autentica√ß√£o an√¥nima');
                document.getElementById('analyzeBtn').disabled = false;
            }
        }

        // Analisar dados existentes
        async function analyzeData() {
            log('Iniciando an√°lise dos dados existentes...');
            updateProgress(10, 'Analisando cole√ß√µes...');

            try {
                // Verificar cole√ß√£o settings > clients
                try {
                    const settingsSnapshot = await db.collection('settings').doc('clients').get();
                    if (settingsSnapshot.exists) {
                        const clientsData = settingsSnapshot.data();
                        log(`Encontrados dados de clientes em settings/clients`);
                        
                        // Acessar a lista de clientes na estrutura correta
                        if (clientsData && clientsData.list && Array.isArray(clientsData.list)) {
                            clientsData.list.forEach(client => {
                                if (client && typeof client === 'object') {
                                    migrationData.clients.push(client);
                                }
                            });
                            log(`Encontrados ${clientsData.list.length} clientes na lista`);
                        } else {
                            log('Lista de clientes n√£o encontrada na estrutura esperada');
                        }
                    } else {
                        log('Documento settings/clients n√£o encontrado');
                    }
                } catch (error) {
                    log(`Erro ao acessar settings/clients: ${error.message}`, 'error');
                }

                updateProgress(50, 'Analisando equipe...');

                // Verificar cole√ß√£o settings > owners
                try {
                    const ownersSnapshot = await db.collection('settings').doc('owners').get();
                    if (ownersSnapshot.exists) {
                        const ownersData = ownersSnapshot.data();
                        log(`Encontrados dados de owners em settings/owners`);
                        
                        // Acessar a lista de nomes na estrutura correta
                        if (ownersData && ownersData.names && Array.isArray(ownersData.names)) {
                            ownersData.names.forEach((name, index) => {
                                if (name && typeof name === 'string') {
                                    migrationData.team.push({
                                        id: `owner_${index}`,
                                        name: name
                                    });
                                }
                            });
                            log(`Encontrados ${ownersData.names.length} membros da equipe`);
                        } else {
                            log('Lista de owners n√£o encontrada na estrutura esperada');
                        }
                    } else {
                        log('Documento settings/owners n√£o encontrado');
                    }
                } catch (error) {
                    log(`Erro ao acessar settings/owners: ${error.message}`, 'error');
                }

                updateProgress(100, 'An√°lise conclu√≠da!');
                log(`An√°lise conclu√≠da: ${migrationData.clients.length} clientes, ${migrationData.team.length} membros da equipe`);
                
                updateStats();
                document.getElementById('migrateBtn').disabled = false;
                showStatus('üìä An√°lise conclu√≠da - Pronto para migra√ß√£o', 'info');

            } catch (error) {
                log(`Erro na an√°lise: ${error.message}`, 'error');
                showStatus('‚ùå Erro na an√°lise dos dados', 'error');
            }
        }

        // Executar migra√ß√£o
        async function startMigration() {
            log('Iniciando migra√ß√£o dos dados...');
            updateProgress(0, 'Preparando migra√ß√£o...');

            try {
                let progress = 0;
                const totalItems = migrationData.clients.length + migrationData.team.length;
                
                // Migrar clientes (settings > clients ‚Üí clients)
                log('Migrando clientes para nova cole√ß√£o...');
                for (let i = 0; i < migrationData.clients.length; i++) {
                    const client = migrationData.clients[i];
                    try {
                        // Mapear campos para schema Taskora v5.5 com valores seguros
                        const task–æ—Ä–∞Client = {
                            name: (client.name && typeof client.name === 'string') ? client.name : (client.id || 'Cliente Sem Nome'),
                            tier: (client.tier && typeof client.tier === 'string') ? client.tier : 'standard',
                            status: (client.status && typeof client.status === 'string') ? client.status : 'active',
                            owner: (client.owner && typeof client.owner === 'string') ? client.owner : '',
                            createdAt: client.createdAt || firebase.firestore.Timestamp.now(),
                            updatedAt: firebase.firestore.Timestamp.now(),
                            // Campos de performance (valores seguros)
                            realBilling: (typeof client.realBilling === 'number') ? client.realBilling : 0,
                            realLeads: (typeof client.realLeads === 'number') ? client.realLeads : 0,
                            billingGoal: (typeof client.billingGoal === 'number') ? client.billingGoal : 0,
                            leadsGoal: (typeof client.leadsGoal === 'number') ? client.leadsGoal : 0,
                            roi: (typeof client.roi === 'number') ? client.roi : 0,
                            // Saldos das plataformas (estruturas seguras)
                            metaAds: (client.metaAds && typeof client.metaAds === 'object') ? {
                                deposit: (typeof client.metaAds.deposit === 'number') ? client.metaAds.deposit : 0,
                                depositDate: client.metaAds.depositDate || null,
                                dailyBudget: (typeof client.metaAds.dailyBudget === 'number') ? client.metaAds.dailyBudget : 0
                            } : { deposit: 0, depositDate: null, dailyBudget: 0 },
                            googleAds: (client.googleAds && typeof client.googleAds === 'object') ? {
                                deposit: (typeof client.googleAds.deposit === 'number') ? client.googleAds.deposit : 0,
                                depositDate: client.googleAds.depositDate || null,
                                dailyBudget: (typeof client.googleAds.dailyBudget === 'number') ? client.googleAds.dailyBudget : 0
                            } : { deposit: 0, depositDate: null, dailyBudget: 0 },
                            tiktokAds: (client.tiktokAds && typeof client.tiktokAds === 'object') ? {
                                deposit: (typeof client.tiktokAds.deposit === 'number') ? client.tiktokAds.deposit : 0,
                                depositDate: client.tiktokAds.depositDate || null,
                                dailyBudget: (typeof client.tiktokAds.dailyBudget === 'number') ? client.tiktokAds.dailyBudget : 0
                            } : { deposit: 0, depositDate: null, dailyBudget: 0 },
                            pinterestAds: (client.pinterestAds && typeof client.pinterestAds === 'object') ? {
                                deposit: (typeof client.pinterestAds.deposit === 'number') ? client.pinterestAds.deposit : 0,
                                depositDate: client.pinterestAds.depositDate || null,
                                dailyBudget: (typeof client.pinterestAds.dailyBudget === 'number') ? client.pinterestAds.dailyBudget : 0
                            } : { deposit: 0, depositDate: null, dailyBudget: 0 }
                        };

                        await db.collection('clients').doc(client.id).set(task–æ—Ä–∞Client);
                        migrationData.stats.migrated++;
                        log(`Cliente migrado: ${task–æ—Ä–∞Client.name}`);
                    } catch (error) {
                        migrationData.errors.push(`Cliente ${client.id}: ${error.message}`);
                        migrationData.stats.errors++;
                        log(`Erro ao migrar cliente ${client.id}: ${error.message}`, 'error');
                    }
                    
                    progress = Math.round(((i + 1) / totalItems) * 50);
                    updateProgress(progress, `Migrando clientes... ${i + 1}/${migrationData.clients.length}`);
                }

                // Migrar equipe (owners ‚Üí team)
                log('Migrando equipe para nova cole√ß√£o...');
                for (let i = 0; i < migrationData.team.length; i++) {
                    const member = migrationData.team[i];
                    try {
                        // Mapear campos para schema Taskora v5.5 com valores seguros
                        const task–æ—Ä–∞Member = {
                            name: (member.name && typeof member.name === 'string') ? member.name : 
                                  (member.displayName && typeof member.displayName === 'string') ? member.displayName : 
                                  'Membro Sem Nome',
                            email: (member.email && typeof member.email === 'string') ? member.email : '',
                            specialty: (member.specialty && typeof member.specialty === 'string') ? member.specialty : 'general',
                            level: (member.level && typeof member.level === 'string') ? member.level : 'junior',
                            status: (member.status && typeof member.status === 'string') ? member.status : 'active',
                            createdAt: member.createdAt || firebase.firestore.Timestamp.now(),
                            updatedAt: firebase.firestore.Timestamp.now()
                        };

                        await db.collection('team').doc(member.id).set(task–æ—Ä–∞Member);
                        migrationData.stats.migrated++;
                        log(`Membro da equipe migrado: ${task–æ—Ä–∞Member.name}`);
                    } catch (error) {
                        migrationData.errors.push(`Equipe ${member.id}: ${error.message}`);
                        migrationData.stats.errors++;
                        log(`Erro ao migrar membro ${member.id}: ${error.message}`, 'error');
                    }
                    
                    progress = 50 + Math.round(((i + 1) / migrationData.team.length) * 50);
                    updateProgress(progress, `Migrando equipe... ${i + 1}/${migrationData.team.length}`);
                }

                updateProgress(100, 'Migra√ß√£o conclu√≠da!');
                log(`Migra√ß√£o conclu√≠da! ${migrationData.stats.migrated} itens migrados, ${migrationData.stats.errors} erros`);
                
                updateStats();
                document.getElementById('validateBtn').disabled = false;
                document.getElementById('exportBtn').disabled = false;
                
                if (migrationData.stats.errors === 0) {
                    showStatus('‚úÖ Migra√ß√£o conclu√≠da com sucesso!', 'success');
                } else {
                    showStatus(`‚ö†Ô∏è Migra√ß√£o conclu√≠da com ${migrationData.stats.errors} erros`, 'warning');
                }

            } catch (error) {
                log(`Erro na migra√ß√£o: ${error.message}`, 'error');
                showStatus('‚ùå Erro na migra√ß√£o dos dados', 'error');
            }
        }

        // Validar migra√ß√£o
        async function validateMigration() {
            log('Validando dados migrados...');
            updateProgress(0, 'Validando...');

            try {
                // Verificar cole√ß√£o clients
                const clientsSnapshot = await db.collection('clients').get();
                const migratedClients = clientsSnapshot.size;
                
                // Verificar cole√ß√£o team
                const teamSnapshot = await db.collection('team').get();
                const migratedTeam = teamSnapshot.size;

                updateProgress(100, 'Valida√ß√£o conclu√≠da!');
                log(`Valida√ß√£o: ${migratedClients} clientes e ${migratedTeam} membros da equipe nas novas cole√ß√µes`);
                
                if (migratedClients > 0 && migratedTeam > 0) {
                    showStatus('‚úÖ Valida√ß√£o bem-sucedida - Dados migrados corretamente!', 'success');
                } else {
                    showStatus('‚ö†Ô∏è Valida√ß√£o: Algumas cole√ß√µes podem estar vazias', 'warning');
                }

            } catch (error) {
                log(`Erro na valida√ß√£o: ${error.message}`, 'error');
                showStatus('‚ùå Erro na valida√ß√£o', 'error');
            }
        }

        // Exportar relat√≥rio
        function exportResults() {
            const report = {
                timestamp: new Date().toISOString(),
                migration: {
                    totalItems: migrationData.clients.length + migrationData.team.length,
                    migrated: migrationData.stats.migrated,
                    errors: migrationData.stats.errors,
                    clients: migrationData.clients.length,
                    team: migrationData.team.length
                },
                errors: migrationData.errors,
                data: {
                    clients: migrationData.clients,
                    team: migrationData.team
                }
            };

            const blob = new Blob([JSON.stringify(report, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `migration-report-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
            
            log('Relat√≥rio de migra√ß√£o exportado!');
        }

        // Inicializar quando a p√°gina carregar
        window.addEventListener('load', initializeApp);
    </script>
</body>
</html>