<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üöÄ Migra√ß√£o Estrat√©gica D√°cora ‚Üí Taskora v5.5</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            margin: 0;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        .content {
            padding: 30px;
        }
        .info {
            background: #e8f4fd;
            border: 2px solid #667eea;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            color: #1565c0;
        }
        .warning {
            background: #fff3e0;
            border: 2px solid #ff9800;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            color: #e65100;
        }
        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.1em;
            font-weight: bold;
            margin: 10px;
            transition: all 0.3s ease;
        }
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }
        .btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
        }
        .btn.success {
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
        }
        .btn.danger {
            background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%);
        }
        .log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 15px;
            height: 400px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            margin: 20px 0;
        }
        .progress {
            background: #e9ecef;
            border-radius: 10px;
            height: 25px;
            margin: 20px 0;
            overflow: hidden;
        }
        .progress-bar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            height: 100%;
            width: 0%;
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 0.9em;
        }
        .phase-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            margin: 10px 0;
            background: #f8f9fa;
        }
        .status {
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: bold;
        }
        .status.pending { background: #fff3cd; color: #856404; }
        .status.processing { background: #cce5ff; color: #0066cc; }
        .status.success { background: #d4edda; color: #155724; }
        .status.error { background: #f8d7da; color: #721c24; }
        .file-input {
            margin: 20px 0;
            padding: 15px;
            border: 2px dashed #667eea;
            border-radius: 10px;
            text-align: center;
            background: #f8f9ff;
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .stat-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            border: 1px solid #dee2e6;
        }
        .stat-number {
            font-size: 2em;
            font-weight: bold;
            color: #667eea;
        }
        .config-section {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
        }
        .db-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }
        .db-card {
            padding: 15px;
            border-radius: 10px;
            border: 2px solid;
        }
        .db-source {
            background: #e8f5e8;
            border-color: #4CAF50;
            color: #2e7d32;
        }
        .db-target {
            background: #e8f4fd;
            border-color: #667eea;
            color: #1565c0;
        }
        .mapping-preview {
            background: #fff;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üöÄ Migra√ß√£o Estrat√©gica D√°cora ‚Üí Taskora v5.5</h1>
            <p>Extra√ß√£o e sincroniza√ß√£o inteligente de dados para o novo schema</p>
        </div>
        
        <div class="content">
            <div class="info">
                <h3>üéØ Estrat√©gia de Migra√ß√£o</h3>
                <p><strong>Esta ferramenta implementa a migra√ß√£o estrat√©gica:</strong></p>
                <ul>
                    <li>üìÅ <strong>Extra√ß√£o</strong>: Dados do backup D√°cora (tarefas, clientes, respons√°veis)</li>
                    <li>üîÑ <strong>Transforma√ß√£o</strong>: Mapeamento para schema Taskora v5.5</li>
                    <li>üéØ <strong>Destino</strong>: Banco separado (taskora-39404) - sem interferir no D√°cora</li>
                    <li>‚úÖ <strong>Valida√ß√£o</strong>: Integridade e refer√™ncias dos dados migrados</li>
                </ul>
            </div>

            <div class="db-info">
                <div class="db-card db-source">
                    <h4>üìä ORIGEM: D√°cora</h4>
                    <p><strong>Projeto:</strong> dacora---tarefas</p>
                    <p><strong>Fonte:</strong> dacora-export-2025-09-02.json</p>
                    <p><strong>Schema:</strong> Legado D√°cora</p>
                </div>
                <div class="db-card db-target">
                    <h4>üéØ DESTINO: Taskora</h4>
                    <p><strong>Projeto:</strong> taskora-39404</p>
                    <p><strong>Schema:</strong> Taskora v5.5</p>
                    <p><strong>Status:</strong> Ambiente isolado</p>
                </div>
            </div>

            <div class="warning">
                <h4>‚ö†Ô∏è Importante</h4>
                <p>Esta migra√ß√£o ser√° feita para o banco <strong>taskora-39404</strong>, mantendo o banco D√°cora original intacto. Foco especial nas <strong>tarefas</strong> que representam o maior volume de dados.</p>
            </div>

            <div class="file-input">
                <h4>üìÅ Selecionar Backup D√°cora</h4>
                <input type="file" id="fileInput" accept=".json" style="margin: 10px;">
                <p><small>Selecione: <strong>dacora-export-2025-09-02.json</strong></small></p>
            </div>

            <div class="stats" id="statsContainer" style="display: none;">
                <div class="stat-card">
                    <div class="stat-number" id="tasksCount">0</div>
                    <div>Tarefas D√°cora</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="clientsCount">0</div>
                    <div>Clientes √önicos</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="ownersCount">0</div>
                    <div>Respons√°veis</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="migratedCount">0</div>
                    <div>Migrados</div>
                </div>
            </div>

            <div class="progress">
                <div id="progressBar" class="progress-bar">0%</div>
            </div>

            <div id="phasesStatus">
                <div class="phase-item">
                    <span><strong>üìÅ FASE 1: Extra√ß√£o de Dados</strong></span>
                    <span id="status-extraction" class="status pending">Aguardando</span>
                </div>
                <div class="phase-item">
                    <span><strong>üèóÔ∏è FASE 2: Cria√ß√£o Schema Taskora v5.5</strong></span>
                    <span id="status-schema" class="status pending">Aguardando</span>
                </div>
                <div class="phase-item">
                    <span><strong>üë• FASE 3: Migra√ß√£o Clientes</strong></span>
                    <span id="status-clients" class="status pending">Aguardando</span>
                </div>
                <div class="phase-item">
                    <span><strong>üë§ FASE 4: Migra√ß√£o Respons√°veis</strong></span>
                    <span id="status-team" class="status pending">Aguardando</span>
                </div>
                <div class="phase-item">
                    <span><strong>üìã FASE 5: Migra√ß√£o Tarefas (CR√çTICO)</strong></span>
                    <span id="status-tasks" class="status pending">Aguardando</span>
                </div>
                <div class="phase-item">
                    <span><strong>‚úÖ FASE 6: Valida√ß√£o e Integridade</strong></span>
                    <span id="status-validation" class="status pending">Aguardando</span>
                </div>
            </div>

            <div style="text-align: center; margin: 30px 0;">
                <button id="migrateBtn" onclick="startStrategicMigration()" class="btn" disabled>
                    üöÄ INICIAR MIGRA√á√ÉO ESTRAT√âGICA
                </button>
                <button onclick="clearLog()" class="btn" style="background: #6c757d;">
                    üßπ Limpar Log
                </button>
                <button id="validateBtn" onclick="validateMigration()" class="btn success" disabled>
                    ‚úÖ VALIDAR MIGRA√á√ÉO
                </button>
            </div>

            <div id="logContainer" class="log">
                <div>[INFO] Ferramenta de migra√ß√£o estrat√©gica carregada</div>
                <div>[INFO] Aguardando sele√ß√£o do backup D√°cora...</div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK v9 -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, collection, doc, setDoc, writeBatch, getDocs, query, where } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        // Configura√ß√£o do Firebase TASKORA (destino)
        const taskoraConfig = {
            apiKey: "AIzaSyBQt2qBnUR4P3Wd3CPl3c6W9xMCz2yf6-4",
            authDomain: "taskora-39404.firebaseapp.com",
            projectId: "taskora-39404",
            storageBucket: "taskora-39404.firebasestorage.app",
            messagingSenderId: "650011927392",
            appId: "1:650011927392:web:26d75b732ecbb21dacf405"
        };

        // Inicializar Firebase Taskora
        const taskoraApp = initializeApp(taskoraConfig);
        const taskoraDb = getFirestore(taskoraApp);

        let backupData = null;
        let isProcessing = false;
        let extractedData = {
            tasks: [],
            clients: [],
            owners: []
        };

        // Schema Taskora v5.5
        const TASKORA_SCHEMA = {
            clients: {
                id: 'string',
                name: 'string',
                tier: 'string', // 'premium', 'standard', 'basic'
                status: 'string', // 'active', 'inactive', 'suspended'
                owner: 'string',
                createdAt: 'timestamp',
                updatedAt: 'timestamp',
                billing: {
                    plan: 'string',
                    lastPayment: 'timestamp',
                    nextPayment: 'timestamp'
                },
                settings: {
                    notifications: 'boolean',
                    theme: 'string'
                }
            },
            tasks: {
                id: 'string',
                title: 'string',
                description: 'string',
                status: 'string', // 'pending', 'in_progress', 'completed', 'cancelled'
                priority: 'string', // 'low', 'medium', 'high', 'urgent'
                clientId: 'string',
                assignedTo: 'string',
                createdBy: 'string',
                createdAt: 'timestamp',
                updatedAt: 'timestamp',
                dueDate: 'timestamp',
                completedAt: 'timestamp',
                estimatedHours: 'number',
                actualHours: 'number',
                tags: 'array',
                recurrence: {
                    enabled: 'boolean',
                    pattern: 'string',
                    interval: 'number'
                },
                metadata: {
                    source: 'string',
                    migrationDate: 'timestamp'
                }
            },
            team: {
                id: 'string',
                name: 'string',
                email: 'string',
                role: 'string', // 'admin', 'manager', 'member'
                status: 'string', // 'active', 'inactive'
                createdAt: 'timestamp',
                updatedAt: 'timestamp',
                permissions: 'array'
            }
        };

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logContainer = document.getElementById('logContainer');
            const logEntry = document.createElement('div');
            const typeColor = {
                'info': '#17a2b8',
                'success': '#28a745',
                'error': '#dc3545',
                'warning': '#ffc107'
            };
            logEntry.innerHTML = `<span style="color: ${typeColor[type] || '#17a2b8'}">[${timestamp}] [${type.toUpperCase()}] ${message}</span>`;
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        function updateStatus(phase, status, message = '') {
            const statusElement = document.getElementById(`status-${phase}`);
            if (statusElement) {
                statusElement.textContent = message || status;
                statusElement.className = `status ${status}`;
            }
        }

        function updateProgress(percentage, text = '') {
            const progressBar = document.getElementById('progressBar');
            progressBar.style.width = `${percentage}%`;
            progressBar.textContent = text || `${Math.round(percentage)}%`;
        }

        function clearLog() {
            document.getElementById('logContainer').innerHTML = '';
            log('Log limpo', 'info');
        }

        function updateStats() {
            document.getElementById('tasksCount').textContent = extractedData.tasks.length;
            document.getElementById('clientsCount').textContent = extractedData.clients.length;
            document.getElementById('ownersCount').textContent = extractedData.owners.length;
            document.getElementById('statsContainer').style.display = 'grid';
        }

        // Manipulador de arquivo
        document.getElementById('fileInput').addEventListener('change', function(event) {
            const file = event.target.files[0];
            if (file) {
                log(`üìÅ Arquivo selecionado: ${file.name}`, 'info');
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        backupData = JSON.parse(e.target.result);
                        log('‚úÖ Backup D√°cora carregado com sucesso', 'success');
                        log(`üìä Data do backup: ${backupData.exportDate}`, 'info');
                        
                        document.getElementById('migrateBtn').disabled = false;
                        
                    } catch (error) {
                        log(`‚ùå Erro ao ler backup: ${error.message}`, 'error');
                        backupData = null;
                        document.getElementById('migrateBtn').disabled = true;
                    }
                };
                reader.readAsText(file);
            }
        });

        // FASE 1: Extra√ß√£o de dados
        async function extractDataFromBackup() {
            try {
                updateStatus('extraction', 'processing', 'Extraindo...');
                log('üìÅ FASE 1: Iniciando extra√ß√£o de dados do backup D√°cora', 'info');
                
                const collections = backupData.collections || {};
                
                // Extrair tarefas
                if (collections.tasks) {
                    extractedData.tasks = collections.tasks.map(task => ({
                        id: task.id,
                        data: task.data
                    }));
                    log(`üìã Extra√≠das ${extractedData.tasks.length} tarefas`, 'success');
                }
                
                // Extrair clientes √∫nicos
                if (collections.clients && collections.clients[0]?.data?.clients) {
                    const clientsData = collections.clients[0].data.clients;
                    extractedData.clients = clientsData.map(client => ({
                        id: client.id || client.name.toLowerCase().replace(/\s+/g, '-'),
                        name: client.name,
                        tier: client.tier || 'standard',
                        owner: client.owner || 'unknown'
                    }));
                    log(`üë• Extra√≠dos ${extractedData.clients.length} clientes √∫nicos`, 'success');
                }
                
                // Extrair respons√°veis
                if (collections.owners && collections.owners[0]?.data?.names) {
                    const ownersData = collections.owners[0].data.names;
                    extractedData.owners = ownersData.map((name, index) => ({
                        id: name.toLowerCase().replace(/\s+/g, '-'),
                        name: name,
                        role: 'member',
                        status: 'active'
                    }));
                    log(`üë§ Extra√≠dos ${extractedData.owners.length} respons√°veis`, 'success');
                }
                
                updateStats();
                updateStatus('extraction', 'success', 'Conclu√≠da');
                log('‚úÖ FASE 1: Extra√ß√£o conclu√≠da com sucesso', 'success');
                return true;
                
            } catch (error) {
                log(`‚ùå FASE 1: Erro na extra√ß√£o: ${error.message}`, 'error');
                updateStatus('extraction', 'error', 'Erro');
                return false;
            }
        }

        // FASE 2: Criar schema Taskora v5.5
        async function createTaskoraSchema() {
            try {
                updateStatus('schema', 'processing', 'Criando...');
                log('üèóÔ∏è FASE 2: Criando schema Taskora v5.5 no banco destino', 'info');
                
                // Criar documento de configura√ß√£o do schema
                const schemaDoc = {
                    version: '5.5',
                    createdAt: new Date(),
                    collections: ['clients', 'tasks', 'team'],
                    migrationSource: 'dacora-export-2025-09-02',
                    migrationDate: new Date()
                };
                
                await setDoc(doc(taskoraDb, 'system', 'schema'), schemaDoc);
                log('‚úÖ Schema Taskora v5.5 configurado', 'success');
                
                updateStatus('schema', 'success', 'Criado');
                log('‚úÖ FASE 2: Schema criado com sucesso', 'success');
                return true;
                
            } catch (error) {
                log(`‚ùå FASE 2: Erro ao criar schema: ${error.message}`, 'error');
                updateStatus('schema', 'error', 'Erro');
                return false;
            }
        }

        // FASE 3: Migrar clientes
        async function migrateClients() {
            try {
                updateStatus('clients', 'processing', 'Migrando...');
                log('üë• FASE 3: Migrando clientes para schema Taskora v5.5', 'info');
                
                const batch = writeBatch(taskoraDb);
                let migratedCount = 0;
                
                for (const client of extractedData.clients) {
                    const clientDoc = {
                        id: client.id,
                        name: client.name,
                        tier: client.tier,
                        status: 'active',
                        owner: client.owner,
                        createdAt: new Date(),
                        updatedAt: new Date(),
                        billing: {
                            plan: client.tier,
                            lastPayment: null,
                            nextPayment: null
                        },
                        settings: {
                            notifications: true,
                            theme: 'default'
                        },
                        metadata: {
                            source: 'dacora-migration',
                            migrationDate: new Date()
                        }
                    };
                    
                    const docRef = doc(taskoraDb, 'clients', client.id);
                    batch.set(docRef, clientDoc);
                    migratedCount++;
                }
                
                await batch.commit();
                log(`‚úÖ ${migratedCount} clientes migrados com sucesso`, 'success');
                
                updateStatus('clients', 'success', `${migratedCount} migrados`);
                log('‚úÖ FASE 3: Migra√ß√£o de clientes conclu√≠da', 'success');
                return true;
                
            } catch (error) {
                log(`‚ùå FASE 3: Erro na migra√ß√£o de clientes: ${error.message}`, 'error');
                updateStatus('clients', 'error', 'Erro');
                return false;
            }
        }

        // FASE 4: Migrar respons√°veis (team)
        async function migrateTeam() {
            try {
                updateStatus('team', 'processing', 'Migrando...');
                log('üë§ FASE 4: Migrando respons√°veis para schema Taskora v5.5', 'info');
                
                const batch = writeBatch(taskoraDb);
                let migratedCount = 0;
                
                for (const owner of extractedData.owners) {
                    const teamDoc = {
                        id: owner.id,
                        name: owner.name,
                        email: `${owner.id}@taskora.com`, // Email placeholder
                        role: owner.role,
                        status: owner.status,
                        createdAt: new Date(),
                        updatedAt: new Date(),
                        permissions: ['read', 'write'],
                        metadata: {
                            source: 'dacora-migration',
                            migrationDate: new Date()
                        }
                    };
                    
                    const docRef = doc(taskoraDb, 'team', owner.id);
                    batch.set(docRef, teamDoc);
                    migratedCount++;
                }
                
                await batch.commit();
                log(`‚úÖ ${migratedCount} respons√°veis migrados com sucesso`, 'success');
                
                updateStatus('team', 'success', `${migratedCount} migrados`);
                log('‚úÖ FASE 4: Migra√ß√£o de respons√°veis conclu√≠da', 'success');
                return true;
                
            } catch (error) {
                log(`‚ùå FASE 4: Erro na migra√ß√£o de respons√°veis: ${error.message}`, 'error');
                updateStatus('team', 'error', 'Erro');
                return false;
            }
        }

        // FASE 5: Migrar tarefas (CR√çTICO)
        async function migrateTasks() {
            try {
                updateStatus('tasks', 'processing', 'Migrando...');
                log('üìã FASE 5: Migrando tarefas (VOLUME CR√çTICO) para schema Taskora v5.5', 'info');
                
                let migratedCount = 0;
                const batchSize = 500;
                
                // Processar em lotes
                for (let i = 0; i < extractedData.tasks.length; i += batchSize) {
                    const batch = writeBatch(taskoraDb);
                    const batchTasks = extractedData.tasks.slice(i, i + batchSize);
                    
                    for (const task of batchTasks) {
                        const taskData = task.data;
                        
                        // Mapear status D√°cora ‚Üí Taskora
                        const statusMapping = {
                            'Pendente': 'pending',
                            'Em Andamento': 'in_progress',
                            'Conclu√≠da': 'completed',
                            'Cancelada': 'cancelled'
                        };
                        
                        // Mapear prioridade
                        const priorityMapping = {
                            'Baixa': 'low',
                            'M√©dia': 'medium',
                            'Alta': 'high',
                            'Urgente': 'urgent'
                        };
                        
                        const taskDoc = {
                            id: task.id,
                            title: taskData.description || 'Tarefa sem t√≠tulo',
                            description: taskData.description || '',
                            status: statusMapping[taskData.status] || 'pending',
                            priority: priorityMapping[taskData.priority] || 'medium',
                            clientId: taskData.client || 'unknown-client',
                            assignedTo: taskData.owner || 'unassigned',
                            createdBy: taskData.owner || 'system',
                            createdAt: taskData.createdAt ? new Date(taskData.createdAt) : new Date(),
                            updatedAt: taskData.updatedAt ? new Date(taskData.updatedAt) : new Date(),
                            dueDate: taskData.dueDate ? new Date(taskData.dueDate) : null,
                            completedAt: taskData.completedAt ? new Date(taskData.completedAt) : null,
                            estimatedHours: taskData.estimatedHours || 0,
                            actualHours: taskData.actualHours || 0,
                            tags: taskData.tags || [],
                            recurrence: {
                                enabled: taskData.recurrence?.enabled || false,
                                pattern: taskData.recurrence?.pattern || 'none',
                                interval: taskData.recurrence?.interval || 0
                            },
                            metadata: {
                                source: 'dacora-migration',
                                migrationDate: new Date(),
                                originalId: task.id
                            }
                        };
                        
                        const docRef = doc(taskoraDb, 'tasks', task.id);
                        batch.set(docRef, taskDoc);
                        migratedCount++;
                    }
                    
                    await batch.commit();
                    log(`‚úÖ Lote ${Math.ceil((i + batchSize) / batchSize)}: ${Math.min(i + batchSize, extractedData.tasks.length)}/${extractedData.tasks.length} tarefas`, 'info');
                    
                    // Pequena pausa entre lotes
                    await new Promise(resolve => setTimeout(resolve, 100));
                }
                
                log(`üéâ ${migratedCount} tarefas migradas com sucesso!`, 'success');
                document.getElementById('migratedCount').textContent = migratedCount;
                
                updateStatus('tasks', 'success', `${migratedCount} migradas`);
                log('‚úÖ FASE 5: Migra√ß√£o de tarefas (CR√çTICA) conclu√≠da', 'success');
                return true;
                
            } catch (error) {
                log(`‚ùå FASE 5: Erro na migra√ß√£o de tarefas: ${error.message}`, 'error');
                updateStatus('tasks', 'error', 'Erro');
                return false;
            }
        }

        // FASE 6: Valida√ß√£o e integridade
        async function validateMigration() {
            try {
                updateStatus('validation', 'processing', 'Validando...');
                log('‚úÖ FASE 6: Validando integridade dos dados migrados', 'info');
                
                // Validar contagens
                const clientsSnapshot = await getDocs(collection(taskoraDb, 'clients'));
                const tasksSnapshot = await getDocs(collection(taskoraDb, 'tasks'));
                const teamSnapshot = await getDocs(collection(taskoraDb, 'team'));
                
                log(`üìä Valida√ß√£o de contagens:`, 'info');
                log(`   - Clientes: ${clientsSnapshot.size} documentos`, 'info');
                log(`   - Tarefas: ${tasksSnapshot.size} documentos`, 'info');
                log(`   - Respons√°veis: ${teamSnapshot.size} documentos`, 'info');
                
                // Validar refer√™ncias √≥rf√£s
                let orphanTasks = 0;
                const clientIds = new Set();
                clientsSnapshot.forEach(doc => clientIds.add(doc.id));
                
                tasksSnapshot.forEach(doc => {
                    const taskData = doc.data();
                    if (taskData.clientId && !clientIds.has(taskData.clientId)) {
                        orphanTasks++;
                    }
                });
                
                if (orphanTasks > 0) {
                    log(`‚ö†Ô∏è Encontradas ${orphanTasks} tarefas com refer√™ncias √≥rf√£s`, 'warning');
                } else {
                    log('‚úÖ Todas as refer√™ncias cliente-tarefa est√£o √≠ntegras', 'success');
                }
                
                updateStatus('validation', 'success', 'Validada');
                log('‚úÖ FASE 6: Valida√ß√£o conclu√≠da com sucesso', 'success');
                document.getElementById('validateBtn').disabled = false;
                return true;
                
            } catch (error) {
                log(`‚ùå FASE 6: Erro na valida√ß√£o: ${error.message}`, 'error');
                updateStatus('validation', 'error', 'Erro');
                return false;
            }
        }

        // Fun√ß√£o principal de migra√ß√£o
        window.startStrategicMigration = async function() {
            if (isProcessing) {
                log('‚ö†Ô∏è Migra√ß√£o j√° est√° em andamento!', 'warning');
                return;
            }

            if (!backupData) {
                log('‚ùå Nenhum backup carregado!', 'error');
                return;
            }

            // Confirma√ß√£o
            if (!confirm('üöÄ Confirma a migra√ß√£o estrat√©gica D√°cora ‚Üí Taskora v5.5?\n\nEsta opera√ß√£o criar√° o novo schema no banco taskora-39404.')) {
                log('‚ùå Migra√ß√£o cancelada pelo usu√°rio', 'info');
                return;
            }

            isProcessing = true;
            document.getElementById('migrateBtn').disabled = true;
            
            try {
                log('üöÄ INICIANDO MIGRA√á√ÉO ESTRAT√âGICA D√ÅCORA ‚Üí TASKORA V5.5', 'info');
                log('üéØ Destino: taskora-39404.firebaseapp.com', 'info');
                updateProgress(0, 'Iniciando...');
                
                // Executar todas as fases
                const phases = [
                    { name: 'Extra√ß√£o', func: extractDataFromBackup, weight: 10 },
                    { name: 'Schema', func: createTaskoraSchema, weight: 15 },
                    { name: 'Clientes', func: migrateClients, weight: 20 },
                    { name: 'Respons√°veis', func: migrateTeam, weight: 15 },
                    { name: 'Tarefas', func: migrateTasks, weight: 30 },
                    { name: 'Valida√ß√£o', func: validateMigration, weight: 10 }
                ];
                
                let currentProgress = 0;
                
                for (const phase of phases) {
                    updateProgress(currentProgress, `${phase.name}...`);
                    const success = await phase.func();
                    
                    if (!success) {
                        throw new Error(`Falha na fase: ${phase.name}`);
                    }
                    
                    currentProgress += phase.weight;
                    updateProgress(currentProgress, `${phase.name} ‚úÖ`);
                    
                    // Pausa entre fases
                    await new Promise(resolve => setTimeout(resolve, 500));
                }
                
                updateProgress(100, 'üéâ MIGRA√á√ÉO CONCLU√çDA!');
                log('üéâ MIGRA√á√ÉO ESTRAT√âGICA CONCLU√çDA COM SUCESSO!', 'success');
                log('‚úÖ Dados D√°cora migrados para Taskora v5.5', 'success');
                log('üéØ Banco destino: taskora-39404', 'info');
                
            } catch (error) {
                log(`‚ùå Erro durante a migra√ß√£o: ${error.message}`, 'error');
                updateProgress(0, 'Erro na migra√ß√£o');
            } finally {
                isProcessing = false;
                document.getElementById('migrateBtn').disabled = false;
            }
        };

        window.validateMigration = validateMigration;

        // Log inicial
        log('üöÄ Ferramenta de migra√ß√£o estrat√©gica inicializada', 'info');
        log('üéØ Destino: Firebase Taskora (taskora-39404)', 'info');
        log('üìÅ Aguardando backup D√°cora...', 'info');
    </script>
</body>
</html>