<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîÑ Restaurar Clientes do Backup</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .content {
            padding: 30px;
        }
        
        .step {
            background: #f8f9fa;
            border-left: 4px solid #4CAF50;
            padding: 20px;
            margin: 20px 0;
            border-radius: 0 8px 8px 0;
        }
        
        .step h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .btn {
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
            margin: 10px 5px;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(76, 175, 80, 0.4);
        }
        
        .btn:disabled {
            background: #cccccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
        }
        
        .btn-danger:hover {
            box-shadow: 0 5px 15px rgba(231, 76, 60, 0.4);
        }
        
        .log {
            background: #2c3e50;
            color: #ecf0f1;
            padding: 20px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            max-height: 400px;
            overflow-y: auto;
            margin: 20px 0;
            white-space: pre-wrap;
        }
        
        .success { color: #2ecc71; }
        .error { color: #e74c3c; }
        .warning { color: #f39c12; }
        .info { color: #3498db; }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }
        
        .stat-number {
            font-size: 2em;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .progress {
            background: #ecf0f1;
            border-radius: 10px;
            overflow: hidden;
            margin: 20px 0;
        }
        
        .progress-bar {
            background: linear-gradient(90deg, #4CAF50, #45a049);
            height: 20px;
            width: 0%;
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîÑ Restaurar Clientes do Backup</h1>
            <p>Ferramenta para restaurar clientes do arquivo migration-report-offline-2025-09-02.json</p>
        </div>
        
        <div class="content">
            <div class="step">
                <h3>üìä Estat√≠sticas</h3>
                <div class="stats">
                    <div class="stat-card">
                        <div class="stat-number" id="totalClients">0</div>
                        <div>Clientes no Backup</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="restoredClients">0</div>
                        <div>Clientes Restaurados</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="errorCount">0</div>
                        <div>Erros</div>
                    </div>
                </div>
            </div>
            
            <div class="step">
                <h3>üîß A√ß√µes</h3>
                <button class="btn" onclick="conectarFirebase()">üîó Conectar Firebase</button>
                <button class="btn" id="btnCarregar" onclick="carregarBackup()" disabled>üìÅ Carregar Backup</button>
                <button class="btn" id="btnRestaurar" onclick="restaurarClientes()" disabled>üîÑ Restaurar Clientes</button>
                <button class="btn btn-danger" id="btnLimpar" onclick="limparClientes()" disabled>üóëÔ∏è Limpar Clientes</button>
            </div>
            
            <div class="progress">
                <div id="progressBar" class="progress-bar">0%</div>
            </div>
            
            <div class="log" id="log"></div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script>
        // Configura√ß√£o do Firebase (usando as credenciais do projeto)
        const firebaseConfig = {
                apiKey: "AIzaSyD8Qv-wQBJsGrYAhY_6T1iHdWCjtjmxtEQ",
                authDomain: "dacora---tarefas.firebaseapp.com",
                projectId: "dacora---tarefas",
                storageBucket: "dacora---tarefas.appspot.com",
                messagingSenderId: "123456789",
                appId: "1:123456789:web:abcdef123456"
            };

        let app, db;
        let backupData = null;
        let clientesParaRestaurar = [];

        function log(message, type = 'info') {
            const logElement = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const className = type;
            logElement.innerHTML += `<span class="${className}">[${timestamp}] ${message}</span>\n`;
            logElement.scrollTop = logElement.scrollHeight;
            console.log(`[${timestamp}] ${message}`);
        }

        function updateProgress(current, total) {
            const percentage = total > 0 ? Math.round((current / total) * 100) : 0;
            const progressBar = document.getElementById('progressBar');
            progressBar.style.width = percentage + '%';
            progressBar.textContent = percentage + '%';
        }

        function updateStats() {
            document.getElementById('totalClients').textContent = clientesParaRestaurar.length;
        }

        // 1. Conectar ao Firebase
        async function conectarFirebase() {
            try {
                log('üîó Conectando ao Firebase...', 'info');
                
                // Verificar se j√° existe uma inst√¢ncia do Firebase
                if (firebase.apps.length === 0) {
                    // Usar configura√ß√£o do firebase-test.js se dispon√≠vel
                    if (window.firebaseConfig) {
                        app = firebase.initializeApp(window.firebaseConfig);
                    } else {
                        app = firebase.initializeApp(firebaseConfig);
                    }
                } else {
                    app = firebase.app(); // Usar a inst√¢ncia existente
                }
                
                db = firebase.firestore();
                
                // Testar conex√£o
                await db.collection('test').doc('restore-clients').set({
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    status: 'restore_clients_connected'
                });
                
                log('‚úÖ Conex√£o estabelecida com sucesso!', 'success');
                document.getElementById('btnCarregar').disabled = false;
            } catch (error) {
                log(`‚ùå Erro ao conectar: ${error.message}`, 'error');
            }
        }

        // 2. Carregar dados do backup via input file
        async function carregarBackup() {
            try {
                log('üìÅ Selecionando arquivo de backup...', 'info');
                
                // Criar input file para sele√ß√£o do arquivo
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = '.json';
                
                return new Promise((resolve, reject) => {
                    input.onchange = async (event) => {
                        try {
                            const file = event.target.files[0];
                            if (!file) {
                                throw new Error('Nenhum arquivo selecionado');
                            }
                            
                            log(`üìÑ Carregando arquivo: ${file.name}`, 'info');
                            
                            const text = await file.text();
                            backupData = JSON.parse(text);
                            clientesParaRestaurar = backupData.data.clients || [];
                            
                            log(`‚úÖ Backup carregado: ${clientesParaRestaurar.length} clientes encontrados`, 'success');
                            
                            // Atualizar estat√≠sticas
                             document.getElementById('totalClients').textContent = clientesParaRestaurar.length;
                            
                            // Habilitar bot√£o de restaurar
                            document.getElementById('btnRestaurar').disabled = false;
                            
                            resolve();
                        } catch (error) {
                            log(`‚ùå Erro ao processar arquivo: ${error.message}`, 'error');
                            reject(error);
                        }
                    };
                    
                    input.click();
                });

                
            } catch (error) {
                log(`‚ùå Erro ao carregar backup: ${error.message}`, 'error');
            }
        }

        // 3. Restaurar clientes na cole√ß√£o 'clients'
        async function restaurarClientes() {
            if (!db || !clientesParaRestaurar.length) {
                log('‚ùå Firebase n√£o conectado ou backup n√£o carregado!', 'error');
                return;
            }

            if (!confirm(`Confirma a restaura√ß√£o de ${clientesParaRestaurar.length} clientes na cole√ß√£o 'clients'?`)) {
                return;
            }

            try {
                log('üîÑ Iniciando restaura√ß√£o dos clientes...', 'info');
                let sucessos = 0;
                let erros = 0;
                
                for (let i = 0; i < clientesParaRestaurar.length; i++) {
                    const cliente = clientesParaRestaurar[i];
                    
                    try {
                        // Converter para formato Taskora v5.5
                        const clienteTaskora = {
                            orgId: 'dacora',
                            displayName: cliente.name,
                            status: cliente.status || 'active',
                            tier: cliente.tier || 'Standard',
                            responsible: cliente.owner || '',
                            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                            updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                            // Campos de performance
                            realBilling: cliente.realBilling || 0,
                            realLeads: cliente.realLeads || 0,
                            billingGoal: cliente.billingGoal || 0,
                            monthlyLeads: cliente.leadsGoal || 0,
                            currentROI: cliente.roi || 0,
                            // Plataformas (como array para compatibilidade)
                            activePlatforms: [
                                ...(cliente.metaAds && (cliente.metaAds.deposit > 0 || cliente.metaAds.dailyBudget > 0) ? ['meta'] : []),
                                ...(cliente.googleAds && (cliente.googleAds.deposit > 0 || cliente.googleAds.dailyBudget > 0) ? ['google'] : []),
                                ...(cliente.tiktokAds && (cliente.tiktokAds.deposit > 0 || cliente.tiktokAds.dailyBudget > 0) ? ['tiktok'] : []),
                                ...(cliente.pinterestAds && (cliente.pinterestAds.deposit > 0 || cliente.pinterestAds.dailyBudget > 0) ? ['pinterest'] : [])
                            ],
                            // Controle de saldo
                            balanceControl: {
                                meta: {
                                    deposit: cliente.metaAds?.deposit || 0,
                                    depositDate: cliente.metaAds?.depositDate || null,
                                    dailyBudget: cliente.metaAds?.dailyBudget || 0
                                },
                                google: {
                                    deposit: cliente.googleAds?.deposit || 0,
                                    depositDate: cliente.googleAds?.depositDate || null,
                                    dailyBudget: cliente.googleAds?.dailyBudget || 0
                                },
                                tiktok: {
                                    deposit: cliente.tiktokAds?.deposit || 0,
                                    depositDate: cliente.tiktokAds?.depositDate || null,
                                    dailyBudget: cliente.tiktokAds?.dailyBudget || 0
                                },
                                pinterest: {
                                    deposit: cliente.pinterestAds?.deposit || 0,
                                    depositDate: cliente.pinterestAds?.depositDate || null,
                                    dailyBudget: cliente.pinterestAds?.dailyBudget || 0
                                }
                            }
                        };
                        
                        // Salvar na cole√ß√£o 'clients'
                        await db.collection('clients').add(clienteTaskora);
                        sucessos++;
                        
                        log(`‚úÖ Cliente restaurado: ${cliente.name}`, 'success');
                        
                    } catch (error) {
                        erros++;
                        log(`‚ùå Erro ao restaurar ${cliente.name}: ${error.message}`, 'error');
                    }
                    
                    updateProgress(i + 1, clientesParaRestaurar.length);
                    document.getElementById('restoredClients').textContent = sucessos;
                    document.getElementById('errorCount').textContent = erros;
                    
                    // Pequena pausa para n√£o sobrecarregar o Firebase
                    await new Promise(resolve => setTimeout(resolve, 100));
                }
                
                log(`üéâ Restaura√ß√£o conclu√≠da! ${sucessos} sucessos, ${erros} erros`, 'success');
                
            } catch (error) {
                log(`‚ùå Erro na restaura√ß√£o: ${error.message}`, 'error');
            }
        }

        // 4. Limpar cole√ß√£o de clientes (para testes)
        async function limparClientes() {
            if (!db) {
                log('‚ùå Firebase n√£o conectado!', 'error');
                return;
            }

            if (!confirm('ATEN√á√ÉO: Isso ir√° DELETAR TODOS os clientes da cole√ß√£o! Tem certeza?')) {
                return;
            }

            if (!confirm('√öLTIMA CHANCE: Esta opera√ß√£o √© IRREVERS√çVEL! Confirma?')) {
                return;
            }

            try {
                log('üóëÔ∏è Limpando cole√ß√£o de clientes...', 'warning');
                
                const snapshot = await db.collection('clients').get();
                let deletados = 0;
                
                for (const doc of snapshot.docs) {
                    await doc.ref.delete();
                    deletados++;
                    log(`üóëÔ∏è Cliente deletado: ${doc.id}`, 'warning');
                }
                
                log(`‚úÖ ${deletados} clientes deletados`, 'success');
                document.getElementById('restoredClients').textContent = '0';
                
            } catch (error) {
                log(`‚ùå Erro ao limpar: ${error.message}`, 'error');
            }
        }

        // Inicializa√ß√£o autom√°tica
        window.addEventListener('load', async () => {
            await conectarFirebase();
        });
    </script>
</body>
</html>