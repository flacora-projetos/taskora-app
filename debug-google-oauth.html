<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Google OAuth - Taskora</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .btn {
            background: #4285f4;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 0;
            display: block;
            width: 100%;
        }
        .btn:hover {
            background: #3367d6;
        }
        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 15px;
            margin: 10px 0;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
        }
        .error {
            background: #f8d7da;
            border-color: #f5c6cb;
            color: #721c24;
        }
        .success {
            background: #d4edda;
            border-color: #c3e6cb;
            color: #155724;
        }
        .info {
            background: #d1ecf1;
            border-color: #bee5eb;
            color: #0c5460;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Debug Google OAuth - Taskora</h1>
        <p>Esta p√°gina vai ajudar a identificar o problema espec√≠fico com o login do Google.</p>
        
        <button id="testGoogleLogin" class="btn">üîê Testar Login com Google</button>
        <button id="checkConfig" class="btn">‚öôÔ∏è Verificar Configura√ß√£o Firebase</button>
        <button id="checkDomains" class="btn">üåê Verificar Dom√≠nios Autorizados</button>
        <button id="clearLogs" class="btn" style="background: #6c757d;">üóëÔ∏è Limpar Logs</button>
        
        <div id="logs" class="log"></div>
        
        <h3>üìã Checklist de Verifica√ß√£o:</h3>
        <ul>
            <li>‚úÖ Firebase configurado corretamente</li>
            <li>‚ùì Google OAuth habilitado no Firebase Console</li>
            <li>‚ùì OAuth Consent Screen configurada</li>
            <li>‚ùì Dom√≠nios autorizados configurados</li>
            <li>‚ùì API Key com restri√ß√µes corretas</li>
        </ul>
        
        <h3>üîß Informa√ß√µes do Sistema:</h3>
        <div id="systemInfo" class="log info"></div>
        
        <div class="info-section">
            <h3>‚úÖ Status da Configura√ß√£o</h3>
            <div class="success">
                <p><strong>‚úÖ Firebase Config:</strong> Configura√ß√£o oficial confirmada</p>
                <p><strong>‚úÖ Project ID:</strong> dacora---tarefas</p>
                <p><strong>‚úÖ App ID:</strong> 1:406318974539:web:d842997c1b064c0ba56fce</p>
                <p><strong>‚úÖ Auth Domain:</strong> dacora---tarefas.firebaseapp.com</p>
            </div>
        </div>
        
        <div class="error-section" style="background: #ffebee; border: 1px solid #f44336; border-radius: 8px; padding: 20px; margin: 20px 0;">
            <h3 style="color: #d32f2f; margin-top: 0;">üö® Solu√ß√µes para Erro 403</h3>
            <p><strong>Se voc√™ est√° vendo erro 403, siga estas etapas em ordem:</strong></p>
            
            <div style="background: #fff3e0; border: 1px solid #ff9800; border-radius: 4px; padding: 15px; margin: 15px 0;">
                <h4 style="color: #f57c00; margin-top: 0;">‚ö° POSS√çVEL CAUSA: AuthDomain da Vercel</h4>
                <div style="background: #f5f5f5; border: 1px solid #ddd; border-radius: 4px; padding: 10px; margin: 10px 0;">
                    <p><strong>Configura√ß√£o Atual:</strong></p>
                    <code>authDomain: "dacora---tarefas.firebaseapp.com"</code>
                    
                    <p><strong>‚ö†Ô∏è Para aplica√ß√µes na Vercel, pode ser necess√°rio:</strong></p>
                    <ol style="margin: 10px 0; line-height: 1.6;">
                        <li><strong>Manter o authDomain padr√£o do Firebase</strong> (recomendado)</li>
                        <li><strong>OU</strong> configurar para o dom√≠nio da Vercel se necess√°rio</li>
                    </ol>
                </div>
                
                <h4 style="color: #f57c00; margin-top: 15px;">1. Verificar Dom√≠nios Autorizados</h4>
                <ol style="margin: 10px 0; line-height: 1.6;">
                    <li>Acesse o <a href="https://console.firebase.google.com" target="_blank" style="color: #1976d2;">Firebase Console</a></li>
                    <li>Selecione seu projeto: <strong>dacora---tarefas</strong></li>
                    <li>V√° para <strong>Authentication</strong> ‚Üí <strong>Settings</strong> ‚Üí <strong>Authorized domains</strong></li>
                    <li>Adicione os seguintes dom√≠nios:</li>
                    <ul style="margin: 5px 0;">
                        <li><code>localhost</code> (desenvolvimento)</li>
                        <li><code>*.vercel.app</code> (todos os subdom√≠nios da Vercel)</li>
                        <li>Seu dom√≠nio espec√≠fico da Vercel (ex: <code>taskora-app-xyz.vercel.app</code>)</li>
                    </ul>
                </ol>
                
                <h4 style="color: #f57c00; margin-top: 15px;">1.1. Verificar Google Cloud Console</h4>
                <ol style="margin: 10px 0; line-height: 1.6;">
                    <li>Acesse <a href="https://console.cloud.google.com/apis/credentials" target="_blank" style="color: #1976d2;">Google Cloud Console ‚Üí APIs & Services ‚Üí Credentials</a></li>
                    <li>Encontre a chave "Browser key (auto created by Firebase)"</li>
                    <li>Em "Application restrictions" ‚Üí "HTTP referrers"</li>
                    <li>Adicione:</li>
                    <ul style="margin: 5px 0;">
                        <li><code>*.firebaseapp.com/*</code></li>
                        <li><code>*.vercel.app/*</code></li>
                        <li><code>localhost:*</code></li>
                    </ul>
                </ol>
                
                <h4 style="color: #f57c00; margin-top: 15px;">2. Verificar API Identity Toolkit (CR√çTICO)</h4>
                <ol style="margin: 10px 0; line-height: 1.6;">
                    <li>Acesse o <a href="https://console.cloud.google.com" target="_blank" style="color: #1976d2;">Google Cloud Console</a></li>
                    <li>Selecione seu projeto: <strong>dacora---tarefas</strong></li>
                    <li>V√° para <strong>APIs & Services</strong> ‚Üí <strong>Library</strong></li>
                    <li>Procure por <strong>"Identity Toolkit API"</strong></li>
                    <li>Se estiver desabilitada, clique em <strong>ENABLE</strong></li>
                    <li>Aguarde alguns minutos para a API ser ativada</li>
                </ol>
                
                <h4 style="color: #f57c00; margin-top: 15px;">3. Configurar OAuth Consent Screen</h4>
                <ol style="margin: 10px 0; line-height: 1.6;">
                    <li>No Google Cloud Console, v√° para <strong>APIs & Services</strong> ‚Üí <strong>OAuth consent screen</strong></li>
                    <li>Configure as informa√ß√µes b√°sicas do app</li>
                    <li>Adicione <code>localhost</code> nos dom√≠nios autorizados</li>
                    <li>Salve as configura√ß√µes</li>
                </ol>
                
                <div style="background: #e8f5e8; border: 1px solid #4caf50; border-radius: 4px; padding: 10px; margin: 10px 0;">
                    <strong>‚úÖ Nota:</strong> A API Identity Toolkit √© essencial para o funcionamento do Firebase Authentication.
                </div>
                
                <div style="background: #fff8e1; border: 1px solid #ffc107; border-radius: 4px; padding: 10px; margin: 10px 0;">
                    <strong>‚ö†Ô∏è Importante:</strong> Use <code>http://localhost</code> e n√£o <code>http://127.0.0.1</code>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { auth } from './assets/js/config/firebase.js';
        import { GoogleAuthProvider, signInWithPopup } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';

        const logsDiv = document.getElementById('logs');
        const systemInfoDiv = document.getElementById('systemInfo');
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}\n`;
            
            const logElement = document.createElement('div');
            logElement.textContent = logEntry;
            logElement.className = `log ${type}`;
            
            logsDiv.appendChild(logElement);
            logsDiv.scrollTop = logsDiv.scrollHeight;
            
            console.log(`[Debug] ${message}`);
        }
        
        function showSystemInfo() {
            const info = {
                'URL atual': window.location.href,
                'User Agent': navigator.userAgent,
                'Dom√≠nio': window.location.hostname,
                'Protocolo': window.location.protocol,
                'Porta': window.location.port || 'padr√£o',
                'Firebase Auth Domain': auth.app.options.authDomain,
                'Firebase Project ID': auth.app.options.projectId
            };
            
            let infoText = '';
            for (const [key, value] of Object.entries(info)) {
                infoText += `${key}: ${value}\n`;
            }
            
            systemInfoDiv.textContent = infoText;
        }
        
        // Verificar configura√ß√£o do Firebase
        document.getElementById('checkConfig').addEventListener('click', () => {
            log('üîç Verificando configura√ß√£o do Firebase...', 'info');
            
            try {
                log(`‚úÖ Firebase Auth inicializado: ${!!auth}`, 'success');
                log(`‚úÖ Auth Domain: ${auth.app.options.authDomain}`, 'success');
                log(`‚úÖ Project ID: ${auth.app.options.projectId}`, 'success');
                log(`‚úÖ API Key: ${auth.app.options.apiKey.substring(0, 20)}...`, 'success');
                
                // Verificar se o usu√°rio est√° logado
                if (auth.currentUser) {
                    log(`‚úÖ Usu√°rio logado: ${auth.currentUser.email}`, 'success');
                } else {
                    log('‚ÑπÔ∏è Nenhum usu√°rio logado', 'info');
                }
                
            } catch (error) {
                log(`‚ùå Erro na configura√ß√£o: ${error.message}`, 'error');
            }
        });
        
        // Verificar dom√≠nios
        document.getElementById('checkDomains').addEventListener('click', () => {
            log('üåê Verificando dom√≠nios...', 'info');
            
            const currentDomain = window.location.hostname;
            const currentPort = window.location.port;
            const fullDomain = currentPort ? `${currentDomain}:${currentPort}` : currentDomain;
            
            log(`üìç Dom√≠nio atual: ${fullDomain}`, 'info');
            log(`üìç Auth Domain configurado: ${auth.app.options.authDomain}`, 'info');
            
            // Lista de dom√≠nios que devem estar autorizados
            const expectedDomains = [
                'localhost',
                'localhost:8000',
                'vercel.app',
                '*.vercel.app',
                'dacora---tarefas.firebaseapp.com'
            ];
            
            log('üìã Dom√≠nios que devem estar autorizados:', 'info');
            expectedDomains.forEach(domain => {
                log(`   - ${domain}`, 'info');
            });
        });
        
        // Testar login com Google
        document.getElementById('testGoogleLogin').addEventListener('click', async () => {
            const btn = document.getElementById('testGoogleLogin');
            btn.disabled = true;
            btn.textContent = 'üîÑ Testando...';
            
            log('üöÄ Iniciando teste de login com Google...', 'info');
            
            try {
                const provider = new GoogleAuthProvider();
                
                // Configurar provider
                provider.addScope('email');
                provider.addScope('profile');
                provider.setCustomParameters({
                    prompt: 'select_account'
                });
                
                log('‚úÖ Provider Google configurado', 'success');
                log('üîÑ Abrindo popup de login...', 'info');
                
                const result = await signInWithPopup(auth, provider);
                const user = result.user;
                
                log('üéâ LOGIN COM GOOGLE REALIZADO COM SUCESSO!', 'success');
                log(`‚úÖ Usu√°rio: ${user.displayName} (${user.email})`, 'success');
                log(`‚úÖ UID: ${user.uid}`, 'success');
                log(`‚úÖ Provider: ${result.providerId || 'google.com'}`, 'success');
                
                // Verificar token
                const token = await user.getIdToken();
                log(`‚úÖ Token obtido (${token.length} caracteres)`, 'success');
                
            } catch (error) {
                log('‚ùå ERRO NO LOGIN COM GOOGLE:', 'error');
                log(`‚ùå C√≥digo: ${error.code}`, 'error');
                log(`‚ùå Mensagem: ${error.message}`, 'error');
                
                // Erros espec√≠ficos
                if (error.code === 'auth/popup-closed-by-user') {
                    log('‚ÑπÔ∏è Usu√°rio fechou o popup', 'info');
                } else if (error.code === 'auth/popup-blocked') {
                    log('‚ö†Ô∏è Popup foi bloqueado pelo navegador', 'error');
                    log('üí° Solu√ß√£o: Permita popups para este site', 'info');
                } else if (error.code === 'auth/unauthorized-domain') {
                    log('‚ö†Ô∏è Dom√≠nio n√£o autorizado!', 'error');
                    log('üí° Solu√ß√£o: Adicionar dom√≠nio no Firebase Console', 'info');
                } else if (error.code === 'auth/operation-not-allowed') {
                    log('‚ö†Ô∏è Google OAuth n√£o est√° habilitado!', 'error');
                    log('üí° Solu√ß√£o: Habilitar no Firebase Console > Authentication', 'info');
                } else {
                    log(`‚ùå Erro completo: ${JSON.stringify(error, null, 2)}`, 'error');
                }
            } finally {
                btn.disabled = false;
                btn.textContent = 'üîê Testar Login com Google';
            }
        });
        
        // Limpar logs
        document.getElementById('clearLogs').addEventListener('click', () => {
            logsDiv.innerHTML = '';
            log('üóëÔ∏è Logs limpos', 'info');
        });
        
        // Inicializar
        log('üîß Debug Google OAuth inicializado', 'success');
        showSystemInfo();
        
        // Auto-verificar configura√ß√£o
        setTimeout(() => {
            document.getElementById('checkConfig').click();
        }, 1000);
        
    </script>
</body>
</html>