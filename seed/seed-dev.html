<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8"/>
  <title>Taskora Seed DEV (standalone)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <style>
    body { font-family: system-ui, sans-serif; max-width: 720px; margin: 40px auto; padding: 0 16px; }
    button { padding: 10px 16px; border-radius: 8px; border: 1px solid #ddd; cursor: pointer; }
    pre { background: #f7f7f7; padding: 12px; border-radius: 8px; min-height: 120px; }
  </style>
</head>
<body>
  <h1>Taskora — Seed DEV</h1>
  <p>Este utilitário cria automaticamente <b>orgUsers</b>, <b>clients</b> e <b>tasks</b> no <b>schema novo</b>.</p>
  <ol>
    <li>Confirme que o arquivo <code>assets/js/config/firebase-test.js</code> tem o <b>config novo</b>.</li>
    <li>Clique no botão abaixo e aguarde a confirmação.</li>
  </ol>
  <button id="run">Rodar seed</button>
  <pre id="log"></pre>

  <!-- carrega o config do projeto -->
  <script type="module" src="../assets/js/config/firebase-test.js"></script>

  <!-- script do seed -->
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js';
    import { getAuth, signInAnonymously } from 'https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js';
    import {
      getFirestore, doc, setDoc, addDoc, collection,
      serverTimestamp, Timestamp
    } from 'https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js';

    const log = m => (document.getElementById('log').textContent += m + '\n');

    document.getElementById('run').onclick = async () => {
      try {
        if (!window.firebaseConfig) throw new Error('firebaseConfig não encontrado. Verifique ../assets/js/config/firebase-test.js');
        const app = initializeApp(window.firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        await signInAnonymously(auth);
        const uid = auth.currentUser.uid;
        const ORG = 'dacora';

        // user
        const userRef = doc(db, 'orgUsers', ORG, 'users', uid);
        await setDoc(userRef, { displayName: 'Responsável Demo', createdAt: serverTimestamp() }, { merge: true });
        log('Usuário: ' + userRef.path);

        // client
        const clientRef = doc(collection(db, 'clients'));
        await setDoc(clientRef, {
          orgId: ORG, displayName: 'Cliente Demo', status: 'ATIVO',
          defaultAssigneeRef: userRef, createdAt: serverTimestamp(), updatedAt: serverTimestamp()
        });
        log('Cliente: ' + clientRef.path);

        // task (refs + strings p/ UI)
        const now = new Date();
        await addDoc(collection(db, 'tasks'), {
          orgId: ORG, clientRef: clientRef, assigneeRef: userRef,
          client: 'Cliente Demo', owner: 'Responsável Demo',
          title: 'Tarefa Demo (schema novo)', description: 'Teste inicial',
          status: 'NAO_REALIZADA', priority: 'MEDIUM',
          startAt: Timestamp.fromDate(now),
          dueAt: Timestamp.fromDate(new Date(now.getTime()+86400000)),
          estimatedMinutes: 60, spentMinutes: 0,
          createdBy: userRef, createdAt: serverTimestamp(), updatedAt: serverTimestamp()
        });
        log('Tarefa criada.');

        alert('Seed concluído. Abra o app normalmente e recarregue (Ctrl+F5).');
      } catch (e) {
        console.error(e); alert('Erro no seed: ' + e.message);
      }
    };
  </script>
</body>
</html>
