}!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîÑ Migra√ß√£o DADOS BRUTOS D√°cora ‚Üí Taskora v5.5</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f8fafc;
        }
        .container {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        h1 {
            color: #dc2626;
            margin-bottom: 30px;
            text-align: center;
        }
        .warning {
            background: #fef2f2;
            border: 2px solid #dc2626;
            color: #dc2626;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            font-weight: bold;
        }
        .section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
        }
        .section h3 {
            color: #475569;
            margin-top: 0;
        }
        button {
            background: #dc2626;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            margin: 5px;
        }
        button:hover {
            background: #b91c1c;
        }
        button:disabled {
            background: #94a3b8;
            cursor: not-allowed;
        }
        .success {
            background: #dcfce7;
            color: #166534;
            padding: 12px;
            border-radius: 6px;
            margin: 10px 0;
        }
        .error {
            background: #fee2e2;
            color: #dc2626;
            padding: 12px;
            border-radius: 6px;
            margin: 10px 0;
        }
        .info {
            background: #dbeafe;
            color: #1e40af;
            padding: 12px;
            border-radius: 6px;
            margin: 10px 0;
        }
        .progress {
            background: #f1f5f9;
            border-radius: 6px;
            padding: 20px;
            margin: 20px 0;
        }
        .progress-bar {
            background: #e2e8f0;
            height: 8px;
            border-radius: 4px;
            overflow: hidden;
        }
        .progress-fill {
            background: #dc2626;
            height: 100%;
            transition: width 0.3s ease;
        }
        pre {
            background: #f8fafc;
            padding: 15px;
            border-radius: 6px;
            overflow-x: auto;
            font-size: 12px;
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        .stat-card {
            background: #f8fafc;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
        }
        .stat-number {
            font-size: 2em;
            font-weight: bold;
            color: #dc2626;
        }
        .log {
            background: #1e293b;
            color: #e2e8f0;
            padding: 20px;
            border-radius: 8px;
            height: 300px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîÑ Migra√ß√£o DADOS BRUTOS D√°cora ‚Üí Taskora v5.5</h1>
        
        <div class="warning">
            ‚ö†Ô∏è ATEN√á√ÉO: Esta ferramenta extrai APENAS os DADOS BRUTOS do backup da D√°cora e os mapeia para o schema CORRETO do Taskora v5.5. N√ÉO importa estruturas do backup!
        </div>

        <!-- Firebase Config -->
        <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
        <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

        <!-- Estat√≠sticas -->
        <div class="stats">
            <div class="stat-card">
                <div class="stat-number" id="totalTasks">0</div>
                <div>Tasks Encontradas</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="totalClients">0</div>
                <div>Clientes Encontrados</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="totalOwners">0</div>
                <div>Owners Encontrados</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="migrationProgress">0%</div>
                <div>Progresso</div>
            </div>
        </div>

        <!-- Controles -->
        <div class="section">
            <h3>1. Carregar Backup D√°cora</h3>
            <button onclick="carregarBackup()">Carregar dacora-export-2025-09-02.json</button>
            <button onclick="analisarDados()" id="btnAnalisar" disabled>Analisar Dados Brutos</button>
        </div>

        <div class="section">
            <h3>2. Conectar Firebase Taskora</h3>
            <button onclick="conectarFirebase()" id="btnConectar" disabled>Conectar Firebase</button>
        </div>

        <div class="section">
            <h3>3. Migrar Dados Brutos</h3>
            <button onclick="executarMigracao()" id="btnMigrar" disabled>Executar Migra√ß√£o</button>
            <button onclick="validarMigracao()" id="btnValidar" disabled>Validar Migra√ß√£o</button>
        </div>

        <!-- Progress -->
        <div class="progress" id="progressContainer" style="display: none;">
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <div id="progressText">0%</div>
        </div>

        <!-- Log -->
        <div class="section">
            <h3>Log de Execu√ß√£o</h3>
            <div class="log" id="logContainer"></div>
        </div>
    </div>

    <script>
        // Firebase Config - Taskora
        const firebaseConfig = {
            apiKey: "AIzaSyBEZokJOUgNJvjKvN8kNqQzI8Ej7cGxKzE",
            authDomain: "taskora-39404.firebaseapp.com",
            projectId: "taskora-39404",
            storageBucket: "taskora-39404.firebasestorage.app",
            messagingSenderId: "1097282772",
            appId: "1:1097282772:web:b8b8b8b8b8b8b8b8b8b8b8"
        };

        let app, db;
        let dacoraData = null;
        let migrationStats = {
            tasks: { total: 0, migrated: 0 },
            clients: { total: 0, migrated: 0 },
            team: { total: 0, migrated: 0 }
        };

        function log(message, type = 'info') {
            const logDiv = document.getElementById('logContainer');
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : 'info';
            logDiv.innerHTML += `<div class="${className}">[${timestamp}] ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function updateProgress(percentage, text) {
            const progressContainer = document.getElementById('progressContainer');
            const progressFill = document.getElementById('progressFill');
            const progressText = document.getElementById('progressText');
            const migrationProgressStat = document.getElementById('migrationProgress');
            
            progressContainer.style.display = 'block';
            progressFill.style.width = percentage + '%';
            progressText.textContent = text || `${percentage}%`;
            migrationProgressStat.textContent = `${percentage}%`;
        }

        // 1. Carregar Backup D√°cora
        async function carregarBackup() {
            try {
                log('Carregando backup da D√°cora...');
                const response = await fetch('./dacora-export-2025-09-02.json');
                dacoraData = await response.json();
                
                // Extrair APENAS os dados brutos
                const tasks = dacoraData.collections?.tasks || [];
                const clientsData = dacoraData.collections?.clients?.[0]?.data?.clients || [];
                const ownersData = dacoraData.collections?.owners?.[0]?.data?.names || [];
                
                document.getElementById('totalTasks').textContent = tasks.length;
                document.getElementById('totalClients').textContent = clientsData.length;
                document.getElementById('totalOwners').textContent = ownersData.length;
                
                migrationStats.tasks.total = tasks.length;
                migrationStats.clients.total = clientsData.length;
                migrationStats.team.total = ownersData.length;
                
                log(`‚úÖ Dados brutos extra√≠dos: ${tasks.length} tasks, ${clientsData.length} clientes, ${ownersData.length} owners`, 'success');
                document.getElementById('btnAnalisar').disabled = false;
            } catch (error) {
                log(`‚ùå Erro ao carregar backup: ${error.message}`, 'error');
            }
        }

        // 2. Analisar Dados Brutos
        function analisarDados() {
            if (!dacoraData) {
                log('‚ùå Backup n√£o carregado!', 'error');
                return;
            }

            log('üîç Analisando APENAS dados brutos (sem schema)...');
            
            // Analisar Tasks - APENAS dados
            const tasks = dacoraData.collections?.tasks || [];
            if (tasks.length > 0) {
                const sampleTask = tasks[0].data;
                log(`üìã Campos encontrados nas Tasks: ${Object.keys(sampleTask).join(', ')}`);
            }

            // Analisar Clientes - APENAS dados
            const clientsData = dacoraData.collections?.clients?.[0]?.data?.clients || [];
            if (clientsData.length > 0) {
                const sampleClient = clientsData[0];
                log(`üë• Campos encontrados nos Clientes: ${Object.keys(sampleClient).join(', ')}`);
            }

            // Analisar Owners - APENAS dados
            const ownersData = dacoraData.collections?.owners?.[0]?.data?.names || [];
            log(`üë§ Owners encontrados: ${ownersData.join(', ')}`);

            log('‚úÖ An√°lise de dados brutos conclu√≠da!', 'success');
            document.getElementById('btnConectar').disabled = false;
        }

        // 3. Conectar Firebase
        async function conectarFirebase() {
            try {
                log('üîó Conectando ao Firebase Taskora...');
                app = firebase.initializeApp(firebaseConfig);
                db = firebase.firestore();
                
                // Testar conex√£o
                await db.collection('test').doc('connection').set({
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    status: 'connected'
                });
                
                log('‚úÖ Conex√£o com Firebase estabelecida!', 'success');
                document.getElementById('btnMigrar').disabled = false;
            } catch (error) {
                log(`‚ùå Erro ao conectar Firebase: ${error.message}`, 'error');
            }
        }

        // 4. Executar Migra√ß√£o de Dados Brutos
        async function executarMigracao() {
            if (!dacoraData || !db) {
                log('‚ùå Dados ou conex√£o n√£o dispon√≠veis!', 'error');
                return;
            }

            log('üöÄ Iniciando migra√ß√£o de dados brutos...');
            updateProgress(0, 'Iniciando...');

            try {
                // Migrar Team (Owners) - DADOS BRUTOS
                await migrarTeamDadosBrutos();
                updateProgress(33, 'Team migrado');

                // Migrar Clients - DADOS BRUTOS
                await migrarClientsDadosBrutos();
                updateProgress(66, 'Clientes migrados');

                // Migrar Tasks - DADOS BRUTOS
                await migrarTasksDadosBrutos();
                updateProgress(100, 'Migra√ß√£o conclu√≠da!');

                log('‚úÖ Migra√ß√£o de dados brutos conclu√≠da com sucesso!', 'success');
                document.getElementById('btnValidar').disabled = false;
            } catch (error) {
                log(`‚ùå Erro na migra√ß√£o: ${error.message}`, 'error');
            }
        }

        // Migrar Team - APENAS DADOS BRUTOS
        async function migrarTeamDadosBrutos() {
            log('üë• Migrando Team com dados brutos...');
            const ownersData = dacoraData.collections?.owners?.[0]?.data?.names || [];
            
            for (const ownerName of ownersData) {
                // Mapear para SCHEMA CORRETO do Taskora v5.5
                const teamData = {
                    name: ownerName,
                    email: `${ownerName.toLowerCase().replace(/\s+/g, '.')}@empresa.com`,
                    phone: '',
                    specialty: ['Gest√£o de Projetos'], // Schema correto
                    level: 'S√™nior',
                    status: 'Ativo',
                    notes: `Migrado da D√°cora - dados brutos`,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                await db.collection('team').add(teamData);
                migrationStats.team.migrated++;
            }

            log(`‚úÖ ${ownersData.length} membros do team migrados`);
        }

        // Migrar Clients - APENAS DADOS BRUTOS
        async function migrarClientsDadosBrutos() {
            log('üë• Migrando Clients com dados brutos...');
            const clientsData = dacoraData.collections?.clients?.[0]?.data?.clients || [];
            
            for (const clientRaw of clientsData) {
                // Mapear para SCHEMA CORRETO do Taskora v5.5
                const clientData = {
                    orgId: 'dacora-migration',
                    displayName: clientRaw.name || 'Cliente sem nome',
                    email: '',
                    phone: '',
                    website: '',
                    instagram: '',
                    status: 'Ativo',
                    tier: mapTierCorreto(clientRaw.tier),
                    defaultAssigneeRef: null,
                    entryDate: new Date().toISOString().split('T')[0],
                    responsible: clientRaw.owner || '',
                    paymentMethod: 'PIX',
                    documents: [],
                    notes: `Migrado da D√°cora - dados brutos. Tier original: ${clientRaw.tier}`,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    // Schema correto v5.5
                    budgets: {
                        meta: { daily: 0, monthly: 0 },
                        google: { daily: 0, monthly: 0 },
                        pinterest: { daily: 0, monthly: 0 }
                    },
                    activePlatforms: {
                        meta: false,
                        google: false,
                        pinterest: false
                    },
                    performance: {
                        realBilling: 0,
                        realLeads: 0,
                        billingGoal: 0,
                        leadsGoal: 0,
                        roi: 0
                    },
                    balanceControl: {
                        meta: { lastDeposit: 0, estimatedBalance: 0 },
                        google: { lastDeposit: 0, estimatedBalance: 0 },
                        pinterest: { lastDeposit: 0, estimatedBalance: 0 }
                    }
                };
                
                await db.collection('clients').add(clientData);
                migrationStats.clients.migrated++;
            }

            log(`‚úÖ ${clientsData.length} clientes migrados`);
        }

        // Migrar Tasks - APENAS DADOS BRUTOS
        async function migrarTasksDadosBrutos() {
            log('üìã Migrando Tasks com dados brutos...');
            const tasks = dacoraData.collections?.tasks || [];
            const batchSize = 50;
            
            for (let i = 0; i < tasks.length; i += batchSize) {
                const batch = db.batch();
                const tasksBatch = tasks.slice(i, i + batchSize);
                
                for (const taskRaw of tasksBatch) {
                    const taskData = taskRaw.data;
                    
                    // Mapear para SCHEMA CORRETO do Taskora v5.5
                    const taskMapped = {
                        orgId: 'dacora-migration',
                        clientRef: null, // Ser√° linkado depois
                        title: taskData.description || 'Tarefa sem t√≠tulo',
                        description: taskData.description || '',
                        status: mapStatusCorreto(taskData.status),
                        assigneeRef: null,
                        owner: taskData.owner || '',
                        priority: 'M√©dia',
                        startAt: taskData.date ? new Date(taskData.date) : null,
                        dueAt: taskData.dueDate ? new Date(taskData.dueDate) : null,
                        reminderAt: null,
                        hours: taskData.hours || '00:00',
                        estimatedMinutes: 0,
                        spentMinutes: convertHoursToMinutes(taskData.hours || '00:00'),
                        date: taskData.date || new Date().toISOString().split('T')[0],
                        createdBy: taskData.owner || 'sistema',
                        createdAt: taskData.createdAt ? new Date(taskData.createdAt.seconds * 1000) : firebase.firestore.FieldValue.serverTimestamp(),
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                        deletedAt: null
                    };
                    
                    const taskDoc = db.collection('tasks').doc();
                    batch.set(taskDoc, taskMapped);
                    migrationStats.tasks.migrated++;
                }
                
                await batch.commit();
                log(`üìã Lote ${Math.floor(i/batchSize) + 1} de tasks migrado`);
            }

            log(`‚úÖ ${tasks.length} tasks migradas`);
        }

        // Fun√ß√µes de mapeamento CORRETAS
        function mapTierCorreto(tier) {
            const tierMap = {
                'KEY_ACCOUNT': 'KEY_ACCOUNT',
                'MID_TIER': 'MID_TIER', 
                'LOW_TIER': 'LOW_TIER',
                'key': 'KEY_ACCOUNT',
                'mid': 'MID_TIER',
                'low': 'LOW_TIER'
            };
            return tierMap[tier] || 'LOW_TIER';
        }

        function mapStatusCorreto(status) {
            const statusMap = {
                'conclu√≠da': 'conclu√≠da',
                'em progresso': 'em progresso',
                'iniciada': 'iniciada',
                'n√£o realizada': 'n√£o realizada',
                'completed': 'conclu√≠da',
                'in_progress': 'em progresso',
                'started': 'iniciada',
                'not_done': 'n√£o realizada'
            };
            return statusMap[status] || 'n√£o realizada';
        }

        function convertHoursToMinutes(hoursStr) {
            if (!hoursStr || hoursStr === '00:00') return 0;
            const [hours, minutes] = hoursStr.split(':').map(Number);
            return (hours * 60) + (minutes || 0);
        }

        // 5. Validar Migra√ß√£o
        async function validarMigracao() {
            if (!db) {
                log('‚ùå Conex√£o n√£o dispon√≠vel!', 'error');
                return;
            }

            log('üîç Validando migra√ß√£o...');

            try {
                const tasksSnapshot = await db.collection('tasks').get();
                const clientsSnapshot = await db.collection('clients').get();
                const teamSnapshot = await db.collection('team').get();

                const tasksCount = tasksSnapshot.size;
                const clientsCount = clientsSnapshot.size;
                const teamCount = teamSnapshot.size;

                log(`üìä Documentos no Firestore:`);
                log(`   Tasks: ${tasksCount}/${migrationStats.tasks.total}`);
                log(`   Clients: ${clientsCount}/${migrationStats.clients.total}`);
                log(`   Team: ${teamCount}/${migrationStats.team.total}`);

                if (tasksCount === migrationStats.tasks.total && 
                    clientsCount === migrationStats.clients.total && 
                    teamCount === migrationStats.team.total) {
                    log('‚úÖ Valida√ß√£o conclu√≠da: Todos os dados foram migrados corretamente!', 'success');
                } else {
                    log('‚ö†Ô∏è Discrep√¢ncias encontradas na migra√ß√£o!', 'error');
                }
            } catch (error) {
                log(`‚ùå Erro na valida√ß√£o: ${error.message}`, 'error');
            }
        }
    </script>
</body>
</html>